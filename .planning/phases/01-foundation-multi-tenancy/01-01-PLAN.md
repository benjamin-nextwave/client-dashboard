---
phase: 01-foundation-multi-tenancy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tailwind.config.ts
  - next.config.ts
  - .env.local.example
  - supabase/config.toml
  - supabase/migrations/20260215000001_initial_schema.sql
  - supabase/migrations/20260215000002_custom_access_token_hook.sql
  - supabase/seed.sql
autonomous: false
user_setup:
  - service: supabase
    why: "Database, authentication, and row-level security"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (secret)"
    dashboard_config:
      - task: "Create a new Supabase project (or use existing)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable Custom Access Token Hook after deploying migrations"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Enable 'Custom Access Token Hook' -> Select function: custom_access_token_hook"

must_haves:
  truths:
    - "Next.js 15 project runs with TypeScript and Tailwind CSS"
    - "Supabase CLI is initialized and configured for local development"
    - "clients and profiles tables exist with RLS enabled"
    - "Custom Access Token Hook function exists in the database"
    - "Seed data creates test operator and two test clients for local development"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies including @supabase/supabase-js and @supabase/ssr"
      contains: "@supabase/ssr"
    - path: "supabase/config.toml"
      provides: "Supabase local development configuration"
    - path: "supabase/migrations/20260215000001_initial_schema.sql"
      provides: "clients table, profiles table, RLS policies, indexes"
      contains: "ENABLE ROW LEVEL SECURITY"
    - path: "supabase/migrations/20260215000002_custom_access_token_hook.sql"
      provides: "JWT claims injection function for user_role and client_id"
      contains: "custom_access_token_hook"
    - path: "supabase/seed.sql"
      provides: "Test data for local development"
      contains: "INSERT INTO public.clients"
  key_links:
    - from: "supabase/migrations/20260215000002_custom_access_token_hook.sql"
      to: "public.profiles"
      via: "SELECT query inside hook function"
      pattern: "FROM public\\.profiles"
    - from: "supabase/migrations/20260215000001_initial_schema.sql"
      to: "auth.users"
      via: "profiles.id foreign key reference"
      pattern: "REFERENCES auth\\.users"
---

<objective>
Initialize the Next.js 15 project with TypeScript and Tailwind CSS, set up Supabase CLI for local development, and create all database migrations for the multi-tenant schema including clients table, profiles table, RLS policies, custom access token hook, and seed data.

Purpose: Establishes the entire project foundation -- every subsequent plan depends on this project structure and database schema existing.
Output: Runnable Next.js project with Supabase migrations ready to deploy.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project and install Supabase dependencies</name>
  <files>
    package.json
    tsconfig.json
    tailwind.config.ts
    next.config.ts
    .env.local.example
    supabase/config.toml
  </files>
  <action>
    1. Create Next.js 15 project in the current directory using: `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --use-npm` (accept defaults for import alias @/*)
    2. Install Supabase packages: `npm install @supabase/supabase-js @supabase/ssr`
    3. Install Supabase CLI as dev dependency: `npm install -D supabase`
    4. Initialize Supabase: `npx supabase init`
    5. Create `.env.local.example` with the three required env vars (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY) as empty placeholders with comments explaining where to find each value
    6. Add `.env.local` to `.gitignore` if not already present
    7. Verify the project builds: `npm run build`

    Note: Use Next.js 15.x (not 16) per research recommendation -- better Supabase compatibility.
  </action>
  <verify>
    - `npm run build` completes without errors
    - `ls supabase/config.toml` exists
    - `cat .env.local.example` shows all three env vars
    - `npm list @supabase/ssr` shows 0.8.x installed
  </verify>
  <done>Next.js 15 project builds successfully, Supabase CLI initialized, all dependencies installed, env template created</done>
</task>

<task type="auto">
  <name>Task 2: Create database migrations, RLS policies, access token hook, and seed data</name>
  <files>
    supabase/migrations/20260215000001_initial_schema.sql
    supabase/migrations/20260215000002_custom_access_token_hook.sql
    supabase/seed.sql
  </files>
  <action>
    Create two migration files and a seed file:

    **Migration 1: Initial schema (20260215000001_initial_schema.sql)**
    - Create `public.clients` table: id (UUID PK, gen_random_uuid), company_name (TEXT NOT NULL), primary_color (TEXT NOT NULL DEFAULT '#3B82F6'), logo_url (TEXT), meeting_url (TEXT), is_recruitment (BOOLEAN NOT NULL DEFAULT FALSE), created_at (TIMESTAMPTZ NOT NULL DEFAULT NOW()), updated_at (TIMESTAMPTZ NOT NULL DEFAULT NOW())
    - Enable RLS on clients: `ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY`
    - Create index: `idx_clients_id ON public.clients(id)`
    - Create `public.profiles` table: id (UUID PK REFERENCES auth.users(id) ON DELETE CASCADE), user_role (TEXT NOT NULL CHECK IN ('operator', 'client')), client_id (UUID REFERENCES public.clients(id) ON DELETE SET NULL), display_name (TEXT), created_at (TIMESTAMPTZ NOT NULL DEFAULT NOW()), updated_at (TIMESTAMPTZ NOT NULL DEFAULT NOW())
    - Enable RLS on profiles: `ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY`
    - Create indexes: `idx_profiles_client_id` on client_id, `idx_profiles_user_role` on user_role
    - RLS policies for clients:
      - "Operators can do everything with clients" FOR ALL TO authenticated USING/WITH CHECK user_role = 'operator' (use SELECT wrapper on auth.jwt())
      - "Clients can view own client record" FOR SELECT TO authenticated USING id::TEXT = client_id from JWT (use SELECT wrapper)
    - RLS policies for profiles:
      - "Operators can view all profiles" FOR SELECT TO authenticated USING user_role = 'operator'
      - "Users can view own profile" FOR SELECT TO authenticated USING id = auth.uid() (use SELECT wrapper)
      - "Auth admin reads profiles" AS PERMISSIVE FOR SELECT TO supabase_auth_admin USING (true)
    - IMPORTANT: Always wrap auth.jwt() and auth.uid() calls in (SELECT ...) for performance per research anti-patterns

    **Migration 2: Custom Access Token Hook (20260215000002_custom_access_token_hook.sql)**
    - Create function `public.custom_access_token_hook(event JSONB) RETURNS JSONB` as PL/pgSQL STABLE
    - Function logic: look up user's profile by event->>'user_id', inject user_role and client_id into claims
    - Grant USAGE ON SCHEMA public TO supabase_auth_admin
    - Grant EXECUTE on the function TO supabase_auth_admin
    - REVOKE EXECUTE FROM authenticated, anon, public
    - Grant ALL ON TABLE public.profiles TO supabase_auth_admin
    - Follow exact pattern from research Pattern 3

    **Seed file (supabase/seed.sql)**
    - Insert two test clients: 'Acme Corp' (id: aaaaaaaa-...) and 'Beta Industries' (id: bbbbbbbb-...)
    - Insert three test users in auth.users: operator (id: 11111111-...), clienta (id: 22222222-...), clientb (id: 33333333-...)
    - Insert matching profiles linking users to roles and clients
    - Note: Seed file is for local dev only, not production
  </action>
  <verify>
    - All three SQL files exist in the correct locations
    - Migration 1 contains ENABLE ROW LEVEL SECURITY for both tables
    - Migration 1 contains (SELECT auth.jwt()) wrappers in all RLS policies (not bare auth.jwt())
    - Migration 2 contains the custom_access_token_hook function with proper grants
    - Seed file contains test data for operator, two clients, and profiles
  </verify>
  <done>Database schema with RLS policies, custom access token hook, and seed data are ready for deployment via `supabase db push` or `supabase start`</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete project scaffolding with Next.js 15, Supabase CLI, database migrations (clients + profiles tables with RLS), custom access token hook, and seed data for local development.</what-built>
  <how-to-verify>
    1. Verify the project builds: `npm run build` should complete without errors
    2. Review `.env.local.example` -- it should list all three Supabase env vars
    3. Review `supabase/migrations/` -- two migration files should exist
    4. Review `supabase/seed.sql` -- test data for operator + two clients
    5. If you have a Supabase project ready: copy `.env.local.example` to `.env.local`, fill in your values, and run `npx supabase start` to test locally
    6. IMPORTANT: After deploying migrations to your Supabase project, you must manually enable the Custom Access Token Hook in Supabase Dashboard -> Authentication -> Hooks
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `supabase/config.toml` exists
- Two migration files exist in `supabase/migrations/`
- All RLS policies use `(SELECT auth.jwt() ->> ...)` wrapper pattern
- Custom access token hook function grants are correct
- Seed data covers operator, two clients, three profiles
</verification>

<success_criteria>
- Next.js 15 project initialized with TypeScript, Tailwind CSS, and ESLint
- @supabase/supabase-js and @supabase/ssr installed
- Supabase CLI initialized with config.toml
- Database schema defines clients and profiles tables with proper constraints
- RLS enabled on all tables with role-based policies
- Custom access token hook ready for deployment
- Seed data available for local development
- Environment variable template documented
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md`
</output>
