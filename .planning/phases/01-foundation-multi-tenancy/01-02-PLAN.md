---
phase: 01-foundation-multi-tenancy
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/types/auth.ts
  - src/middleware.ts
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(auth)/layout.tsx
  - src/app/(operator)/admin/page.tsx
  - src/app/(operator)/layout.tsx
  - src/app/(client)/dashboard/page.tsx
  - src/app/(client)/layout.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Operator can log in and is redirected to /admin"
    - "Client can log in and is redirected to /dashboard"
    - "Unauthenticated user visiting any protected route is redirected to /login"
    - "Client visiting /admin is redirected to /dashboard"
    - "Operator visiting /dashboard is redirected to /admin"
    - "Session persists across browser refresh without re-login"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client (createBrowserClient)"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client with cookie management"
      exports: ["createClient"]
    - path: "src/lib/supabase/admin.ts"
      provides: "Admin Supabase client (service_role, bypasses RLS)"
      exports: ["createAdminClient"]
    - path: "src/middleware.ts"
      provides: "Token refresh + role-based route protection"
      contains: "getUser"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form UI"
      min_lines: 20
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Server action for login with role-based redirect"
      contains: "signInWithPassword"
    - path: "src/app/page.tsx"
      provides: "Root redirect based on auth state and role"
      contains: "redirect"
  key_links:
    - from: "src/app/(auth)/login/actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "import createClient for server-side auth"
      pattern: "from.*@/lib/supabase/server"
    - from: "src/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "Token validation (NOT getSession)"
      pattern: "getUser\\(\\)"
    - from: "src/app/(auth)/login/actions.ts"
      to: "role-based redirect"
      via: "app_metadata.user_role check after signIn"
      pattern: "user_role.*operator.*redirect.*admin"
    - from: "src/middleware.ts"
      to: "cookie management"
      via: "returns supabaseResponse (not NextResponse.next())"
      pattern: "return supabaseResponse"
---

<objective>
Build the complete authentication flow: Supabase client utilities, Next.js middleware for session management and route protection, login page with server action, and role-based route groups with placeholder pages for operator and client dashboards.

Purpose: Delivers AUTH-01 (operator login), AUTH-02 (client login), and AUTH-04 (session persistence) -- the user-facing authentication experience.
Output: Working login flow with role-based routing.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
@.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client utilities and auth types</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/types/auth.ts
  </files>
  <action>
    Create three Supabase client variants following the exact patterns from research:

    **src/lib/supabase/client.ts** -- Browser client
    - Export `createClient()` using `createBrowserClient` from `@supabase/ssr`
    - Uses NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY

    **src/lib/supabase/server.ts** -- Server client
    - Export async `createClient()` using `createServerClient` from `@supabase/ssr`
    - Import `cookies` from `next/headers` (await cookies() -- Next.js 15 async cookies)
    - Implement getAll/setAll cookie handlers with try/catch in setAll (for Server Components)
    - Uses NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY

    **src/lib/supabase/admin.ts** -- Admin client (server-only)
    - Export `createAdminClient()` using `createClient` from `@supabase/supabase-js` (NOT @supabase/ssr)
    - Uses NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY
    - Disable autoRefreshToken and persistSession
    - Add a comment: "NEVER import this in client components"

    **src/types/auth.ts** -- Custom JWT claim types
    - Export type `UserRole = 'operator' | 'client'`
    - Export interface `JWTClaims` with user_role (UserRole), client_id (string | null), sub (string)
    - Export interface `UserProfile` with id (string), user_role (UserRole), client_id (string | null), display_name (string | null)
  </action>
  <verify>
    - `npx tsc --noEmit` passes (type checking)
    - All four files exist in correct locations
    - admin.ts does NOT import from @supabase/ssr
    - server.ts uses `await cookies()` (Next.js 15 pattern)
  </verify>
  <done>Three Supabase client utilities and auth type definitions exist, type-check passes</done>
</task>

<task type="auto">
  <name>Task 2: Create middleware, login page, and role-based route structure</name>
  <files>
    src/middleware.ts
    src/app/(auth)/login/page.tsx
    src/app/(auth)/login/actions.ts
    src/app/(auth)/layout.tsx
    src/app/(operator)/admin/page.tsx
    src/app/(operator)/layout.tsx
    src/app/(client)/dashboard/page.tsx
    src/app/(client)/layout.tsx
    src/app/page.tsx
  </files>
  <action>
    **src/middleware.ts** -- Session refresh + route protection
    - Follow exact research Pattern 2 structure
    - Create Supabase server client with cookie getAll/setAll handlers
    - CRITICAL: Use `supabase.auth.getUser()` NOT `getSession()` for token validation
    - Redirect unauthenticated users to /login (except /login itself)
    - Role-based protection: operators accessing /dashboard routes redirect to /admin, clients accessing /admin routes redirect to /dashboard
    - Read role from JWT: user's app_metadata.user_role (available after Custom Access Token Hook runs)
    - CRITICAL: Return `supabaseResponse` (the modified response), NOT a new NextResponse.next()
    - Matcher: exclude static files, images, favicon

    **src/app/(auth)/layout.tsx** -- Auth layout
    - Simple centered layout (no sidebar), suitable for login/auth pages
    - Accepts children prop, renders them centered on page
    - Minimal Tailwind: flex min-h-screen items-center justify-center bg-gray-50

    **src/app/(auth)/login/page.tsx** -- Login page
    - Simple form with email and password fields
    - Uses the login server action from actions.ts
    - Displays error message if login fails (use useActionState or a simple state pattern)
    - Clean Tailwind styling: card with shadow, form fields, submit button
    - No "sign up" link -- accounts are operator-provisioned only
    - Title: "Inloggen" (Dutch for Login)

    **src/app/(auth)/login/actions.ts** -- Login server action
    - 'use server' directive
    - Import createClient from @/lib/supabase/server
    - Call signInWithPassword with email and password from FormData
    - On error: return { error: error.message }
    - On success: check data.user.app_metadata.user_role
      - If 'operator': revalidatePath then redirect to '/admin'
      - If 'client': revalidatePath then redirect to '/dashboard'

    **src/app/(operator)/layout.tsx** -- Operator layout
    - Simple layout with a top bar showing "NextWave Admin" and a logout button
    - Logout button calls a server action that signs out and redirects to /login
    - Children rendered below the top bar

    **src/app/(operator)/admin/page.tsx** -- Operator dashboard placeholder
    - Simple page showing "Operator Dashboard" heading
    - Fetch current user via server client to display operator name
    - Placeholder text: "Client management coming in Phase 2"

    **src/app/(client)/layout.tsx** -- Client layout
    - Simple layout with a top bar showing "Dashboard" and a logout button
    - Similar to operator layout but client-branded (will be enhanced in Phase 3)
    - Children rendered below the top bar

    **src/app/(client)/dashboard/page.tsx** -- Client dashboard placeholder
    - Simple page showing "Welkom" (Welcome in Dutch) heading
    - Fetch current user via server client to display user info
    - Placeholder text: "Uw dashboard wordt binnenkort beschikbaar" (Your dashboard will be available soon)

    **src/app/page.tsx** -- Root page (role-based redirect)
    - Server component that checks auth state
    - If not authenticated: redirect to /login
    - If operator: redirect to /admin
    - If client: redirect to /dashboard
    - Remove any default Next.js boilerplate content

    Also clean up: Remove default Next.js page content (the Vercel template), update src/app/globals.css to keep only Tailwind directives (@tailwind base/components/utilities) and remove the default Next.js styles.
  </action>
  <verify>
    - `npm run build` succeeds
    - `npx tsc --noEmit` passes
    - middleware.ts contains `getUser()` (not getSession)
    - middleware.ts returns `supabaseResponse`
    - login/actions.ts contains `signInWithPassword`
    - login/actions.ts contains role-based redirect logic
    - All route group directories exist: (auth), (operator), (client)
    - Root page.tsx redirects based on role
  </verify>
  <done>
    Complete auth flow implemented:
    - Unauthenticated users see login page at /login
    - Operators redirected to /admin after login
    - Clients redirected to /dashboard after login
    - Middleware refreshes tokens and enforces role-based route access
    - Session persists across browser refresh via cookie-based tokens
    - Both dashboard placeholders render with appropriate content
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- Middleware uses getUser() not getSession()
- Middleware returns supabaseResponse not NextResponse.next()
- Login server action uses signInWithPassword with role-based redirect
- Three route groups exist: (auth), (operator), (client)
- Admin client uses service_role key and is server-only
- Root page redirects based on auth state and role
</verification>

<success_criteria>
- AUTH-01: Operator can log in and see the operator dashboard at /admin
- AUTH-02: Client can log in and see their dashboard at /dashboard
- AUTH-04: Browser refresh does not require re-login (cookie-based session)
- Role isolation: clients cannot access /admin, operators cannot access /dashboard
- Unauthenticated access redirects to /login
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-02-SUMMARY.md`
</output>
