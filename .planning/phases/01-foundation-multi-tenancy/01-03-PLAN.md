---
phase: 01-foundation-multi-tenancy
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/tests/rls_tenant_isolation.test.sql
autonomous: true

must_haves:
  truths:
    - "Client A cannot read Client B's client record"
    - "Client A cannot update or delete Client B's client record"
    - "Client A cannot read Client B's profile"
    - "Operator can read all client records"
    - "Operator can create, update, and delete client records"
    - "Unauthenticated (anon) user cannot access any data"
  artifacts:
    - path: "supabase/tests/rls_tenant_isolation.test.sql"
      provides: "pgTAP test suite verifying tenant isolation across all tables"
      contains: "SELECT plan("
      min_lines: 50
  key_links:
    - from: "supabase/tests/rls_tenant_isolation.test.sql"
      to: "public.clients"
      via: "SELECT/INSERT/UPDATE/DELETE queries as different roles"
      pattern: "FROM public\\.clients"
    - from: "supabase/tests/rls_tenant_isolation.test.sql"
      to: "public.profiles"
      via: "SELECT queries as different roles"
      pattern: "FROM public\\.profiles"
---

<objective>
Create comprehensive pgTAP tests that verify row-level security policies enforce strict tenant isolation. Tests authenticate as different users (operator, client A, client B, anon) and verify that cross-tenant data access is impossible through any query path.

Purpose: Delivers AUTH-03 (RLS enforcement verification) and roadmap success criterion #5 (integration tests verify Client A cannot access Client B data). These tests serve as a regression safety net for every future migration.
Output: pgTAP test suite runnable via `supabase test db`.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-multi-tenancy/01-RESEARCH.md
@.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pgTAP tenant isolation test suite</name>
  <files>
    supabase/tests/rls_tenant_isolation.test.sql
  </files>
  <action>
    Create a comprehensive pgTAP test file following the pattern from research. The test must:

    **Setup:**
    - BEGIN transaction (everything rolls back at the end)
    - CREATE EXTENSION IF NOT EXISTS pgtap WITH SCHEMA extensions
    - SELECT plan(N) with the correct count of test assertions
    - Insert two test clients with fixed UUIDs (aaaaaaaa-... and bbbbbbbb-...)
    - Insert three test users in auth.users (operator 11111111-..., clienta 22222222-..., clientb 33333333-...)
    - Insert three profiles linking users to roles and clients

    **Client A isolation tests (SET LOCAL request.jwt.claims with client A's claims):**
    1. Client A can SELECT their own client record (results_eq, expects only 'Client A Corp')
    2. Client A CANNOT SELECT Client B's record (is_empty)
    3. Client A CANNOT UPDATE Client B's record (is_empty with RETURNING)
    4. Client A CANNOT DELETE Client B's record (is_empty with RETURNING)
    5. Client A CANNOT INSERT a new client record (throws_ok or equivalent)
    6. Client A can SELECT their own profile (results_eq)
    7. Client A CANNOT SELECT Client B's profile (is_empty)

    **Client B isolation tests (SET LOCAL with client B's claims):**
    8. Client B can SELECT only their own client record
    9. Client B CANNOT access Client A's data

    **Operator tests (SET LOCAL with operator claims):**
    10. Operator can SELECT all client records (count = 2)
    11. Operator can INSERT a new client (lives_ok)
    12. Operator can UPDATE a client (lives_ok)
    13. Operator can SELECT all profiles (count = 3)

    **Anon tests (SET LOCAL role to anon):**
    14. Anon user CANNOT SELECT from clients (is_empty)
    15. Anon user CANNOT SELECT from profiles (is_empty)

    **Teardown:**
    - SELECT * FROM finish()
    - ROLLBACK

    Use SET LOCAL role = 'authenticated' before authenticated tests and SET LOCAL role = 'anon' for anon tests. Use SET LOCAL request.jwt.claims = '{...}' to simulate JWT claims for each user context.

    Target: 15+ test assertions covering SELECT, INSERT, UPDATE, DELETE for both tables across all three role types plus anon.
  </action>
  <verify>
    - File exists at supabase/tests/rls_tenant_isolation.test.sql
    - File contains BEGIN and ROLLBACK (transaction wrapping)
    - File contains SELECT plan(N) matching the actual number of assertions
    - File tests at least: client-to-client isolation (both directions), operator full access, anon no access
    - File tests both tables: clients and profiles
    - File tests all CRUD operations (SELECT, INSERT, UPDATE, DELETE) where relevant
    - If Supabase local is running: `npx supabase test db` passes all assertions
  </verify>
  <done>
    pgTAP test suite exists with 15+ assertions verifying:
    - Client A cannot access Client B data (any operation, any table)
    - Client B cannot access Client A data
    - Operators have full access to all records
    - Anonymous users have zero access
    - All tests pass via `supabase test db`
  </done>
</task>

</tasks>

<verification>
- `supabase test db` passes all assertions (if local Supabase is running)
- Test file covers cross-tenant isolation in both directions
- Test file covers operator full access
- Test file covers anon no access
- Test file uses proper transaction wrapping (BEGIN/ROLLBACK)
- Test assertions count matches SELECT plan(N)
</verification>

<success_criteria>
- AUTH-03: RLS enforcement verified via database-level tests
- Roadmap criterion #5: Integration tests verify Client A cannot access Client B data through any query path
- Tests serve as regression safety net for all future migrations
- Tests runnable in CI/CD via `supabase test db`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-multi-tenancy/01-03-SUMMARY.md`
</output>
