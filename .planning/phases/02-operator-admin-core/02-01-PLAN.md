---
phase: 02-operator-admin-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_client_campaigns_and_storage.sql
  - next.config.ts
  - src/lib/validations/client.ts
  - src/lib/supabase/storage.ts
  - src/lib/instantly/client.ts
  - src/lib/instantly/types.ts
  - src/types/database.ts
autonomous: true
user_setup:
  - service: instantly
    why: "Campaign listing for client-campaign associations"
    env_vars:
      - name: INSTANTLY_API_KEY
        source: "Instantly.ai Dashboard -> Settings -> Integrations -> API -> Create API Key (ensure campaigns:read scope, requires Growth plan)"

must_haves:
  truths:
    - "client_campaigns junction table exists with RLS policies for operator CRUD and client SELECT"
    - "client-logos storage bucket exists as public with operator-only upload and 2MB/image-type restrictions"
    - "Operators can INSERT and UPDATE profiles (RLS policies added)"
    - "Zod validation schemas exist for client create and edit forms"
    - "Instantly API wrapper can fetch campaigns with Bearer token auth"
    - "Storage helper can upload and delete client logos with validation"
  artifacts:
    - path: "supabase/migrations/20260216000001_client_campaigns_and_storage.sql"
      provides: "client_campaigns table, storage bucket, profile INSERT/UPDATE RLS policies"
      contains: "CREATE TABLE public.client_campaigns"
    - path: "src/lib/validations/client.ts"
      provides: "Zod schemas for client forms"
      exports: ["clientFormSchema", "clientEditSchema", "ClientFormValues", "ClientEditValues"]
    - path: "src/lib/instantly/client.ts"
      provides: "Instantly API v2 campaign listing"
      exports: ["listCampaigns"]
    - path: "src/lib/supabase/storage.ts"
      provides: "Logo upload/delete helpers"
      exports: ["uploadClientLogo", "deleteClientLogo"]
  key_links:
    - from: "src/lib/instantly/client.ts"
      to: "process.env.INSTANTLY_API_KEY"
      via: "Bearer token in Authorization header"
      pattern: "Authorization.*Bearer.*INSTANTLY_API_KEY"
    - from: "src/lib/supabase/storage.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient import for service_role uploads"
      pattern: "import.*createAdminClient.*from.*admin"
---

<objective>
Set up the Phase 2 foundation: database migration for client_campaigns junction table and storage bucket, install new packages (zod, react-hook-form, @hookform/resolvers), create shared validation schemas, Instantly.ai API wrapper, and storage upload helpers.

Purpose: All subsequent plans (client creation, client editing) depend on these shared utilities and database schema. This must land first.
Output: Migration file, Zod schemas, Instantly client, storage helpers, updated next.config.ts
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-operator-admin-core/02-RESEARCH.md
@.planning/phases/01-foundation-multi-tenancy/01-01-SUMMARY.md
@.planning/phases/01-foundation-multi-tenancy/01-02-SUMMARY.md
@supabase/migrations/20260215000001_initial_schema.sql
@src/lib/supabase/admin.ts
@src/types/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and create database migration</name>
  <files>
    package.json
    supabase/migrations/20260216000001_client_campaigns_and_storage.sql
    next.config.ts
  </files>
  <action>
    1. Install new dependencies:
       ```bash
       npm install zod@^3.24 react-hook-form@^7.54 @hookform/resolvers@^3.9
       ```

    2. Create migration file `supabase/migrations/20260216000001_client_campaigns_and_storage.sql` with:

       **client_campaigns junction table:**
       - id UUID PK default gen_random_uuid()
       - client_id UUID NOT NULL REFERENCES public.clients(id) ON DELETE CASCADE
       - campaign_id TEXT NOT NULL (Instantly.ai campaign UUID stored as text)
       - campaign_name TEXT NOT NULL (cached name for display without API calls)
       - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       - UNIQUE(client_id, campaign_id) to prevent duplicate associations
       - Enable RLS
       - Index on client_id
       - RLS policy: "Operators can manage campaign associations" FOR ALL using (SELECT auth.jwt() ->> 'user_role') = 'operator' for both USING and WITH CHECK
       - RLS policy: "Clients can view own campaigns" FOR SELECT using client_id::TEXT = (SELECT auth.jwt() ->> 'client_id')

       **Storage bucket for client logos:**
       - INSERT INTO storage.buckets with id='client-logos', name='client-logos', public=TRUE, file_size_limit=2097152 (2MB), allowed_mime_types=ARRAY['image/png','image/jpeg','image/svg+xml','image/webp']
       - RLS policies on storage.objects for bucket_id='client-logos':
         - Operators can INSERT (upload) with operator role check
         - Operators can UPDATE with operator role check
         - Operators can DELETE with operator role check
         - Authenticated users can SELECT (read logos -- clients need to see their own)

       **Profile RLS additions:**
       - "Operators can insert profiles" FOR INSERT with operator role check
       - "Operators can update profiles" FOR UPDATE with operator role check

       All RLS policies MUST use the (SELECT auth.jwt()) subselect wrapper pattern established in Phase 1.

    3. Update `next.config.ts` to increase Server Action body size limit:
       ```typescript
       const nextConfig: NextConfig = {
         experimental: {
           serverActions: {
             bodySizeLimit: '3mb',
           },
         },
       };
       ```
  </action>
  <verify>
    - `npm ls zod react-hook-form @hookform/resolvers` shows all three installed
    - Migration file exists and contains CREATE TABLE, INSERT INTO storage.buckets, and 7+ CREATE POLICY statements
    - `npx next build` succeeds (next.config.ts is valid)
  </verify>
  <done>
    Packages installed, migration file ready for deployment, next.config.ts allows 3MB server action bodies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared library utilities (validation, Instantly client, storage helpers, types)</name>
  <files>
    src/lib/validations/client.ts
    src/lib/instantly/client.ts
    src/lib/instantly/types.ts
    src/lib/supabase/storage.ts
    src/types/database.ts
  </files>
  <action>
    1. Create `src/lib/validations/client.ts`:
       - Import z from 'zod'
       - `clientFormSchema` with fields:
         - companyName: string, min(1, 'Bedrijfsnaam is verplicht'), max(100)
         - email: string, email('Ongeldig e-mailadres')
         - password: string, min(8, 'Wachtwoord moet minimaal 8 tekens bevatten')
         - primaryColor: string, regex(/^#[0-9A-Fa-f]{6}$/, 'Ongeldige kleurcode')
         - isRecruitment: z.coerce.boolean().default(false)
         - meetingUrl: string, url('Ongeldige URL').optional().or(z.literal(''))
       - `clientEditSchema`: omit password, extend with optional password (min 8 or empty string)
       - Export types: ClientFormValues, ClientEditValues

    2. Create `src/lib/instantly/types.ts`:
       - InstantlyCampaign interface: { id: string, name: string, status: number }
       - InstantlyListResponse<T> interface: { items: T[], next_starting_after?: string }

    3. Create `src/lib/instantly/client.ts`:
       - Import types from ./types
       - `listCampaigns(options?)` async function:
         - Accepts optional { search, status, limit, startingAfter }
         - Builds URLSearchParams
         - Fetches from `https://api.instantly.ai/api/v2/campaigns?${params}`
         - Headers: Authorization: `Bearer ${process.env.INSTANTLY_API_KEY}`, Content-Type: application/json
         - cache: 'no-store' (operator needs fresh data)
         - Throws on non-ok response with status info
         - Returns typed InstantlyListResponse<InstantlyCampaign>
       - IMPORTANT: Never prefix env var with NEXT_PUBLIC_. Server-side only.

    4. Create `src/lib/supabase/storage.ts`:
       - Import createAdminClient from './admin'
       - Constants: LOGO_BUCKET = 'client-logos', MAX_LOGO_SIZE = 2 * 1024 * 1024, ALLOWED_TYPES array
       - `uploadClientLogo(clientId: string, file: File)`: validates type and size, uploads to `${clientId}/logo.${ext}` with upsert:true, returns { url: publicUrl } or { error: string }
       - `deleteClientLogo(clientId: string)`: lists files in client folder, removes all
       - Use createAdminClient() for all operations (service_role bypasses storage RLS, appropriate because only operators call this from Server Actions)

    5. Create `src/types/database.ts`:
       - ClientCampaign interface: { id: string, client_id: string, campaign_id: string, campaign_name: string, created_at: string }
       - Client interface: { id: string, company_name: string, primary_color: string, logo_url: string | null, meeting_url: string | null, is_recruitment: boolean, created_at: string, updated_at: string }
       - ClientWithCampaigns type extending Client with campaigns: ClientCampaign[]
  </action>
  <verify>
    - `npx tsc --noEmit` passes (all files type-check)
    - All 5 files exist with correct exports
  </verify>
  <done>
    Zod schemas validate client form data with Dutch error messages, Instantly client can list campaigns, storage helper handles logo upload/delete with validation, database types are defined
  </done>
</task>

</tasks>

<verification>
- All 7 new files exist and are importable
- TypeScript compiles without errors
- Migration SQL is syntactically valid
- No NEXT_PUBLIC_ prefix on INSTANTLY_API_KEY
- Zod schemas produce Dutch error messages
</verification>

<success_criteria>
- `npm ls zod react-hook-form @hookform/resolvers` shows all packages
- `npx tsc --noEmit` passes
- Migration file contains client_campaigns table, storage bucket, and all RLS policies
- next.config.ts has bodySizeLimit: '3mb'
</success_criteria>

<output>
After completion, create `.planning/phases/02-operator-admin-core/02-01-SUMMARY.md`
</output>
