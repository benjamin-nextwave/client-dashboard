---
phase: 02-operator-admin-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(operator)/admin/page.tsx
  - src/app/(operator)/admin/clients/new/page.tsx
  - src/app/(operator)/admin/clients/actions.ts
  - src/components/admin/client-form.tsx
  - src/components/admin/campaign-selector.tsx
  - src/components/admin/logo-upload.tsx
  - src/components/admin/color-picker.tsx
autonomous: true

must_haves:
  truths:
    - "Operator sees a list of all existing clients on the admin page"
    - "Operator can navigate to a 'new client' form"
    - "Operator can fill in company name, email, password, primary color, logo, recruitment toggle, meeting URL, and select campaigns"
    - "Submitting the form creates a client record, auth user, and profile in one transactional operation with cleanup on failure"
    - "After successful creation, operator is redirected back to the client list"
  artifacts:
    - path: "src/app/(operator)/admin/page.tsx"
      provides: "Client list with links to create/edit"
      contains: "clients"
    - path: "src/app/(operator)/admin/clients/new/page.tsx"
      provides: "Create client page"
      contains: "ClientForm"
    - path: "src/app/(operator)/admin/clients/actions.ts"
      provides: "Server Actions for client CRUD"
      exports: ["createClient"]
    - path: "src/components/admin/client-form.tsx"
      provides: "Shared client form component (create and edit)"
      exports: ["ClientForm"]
  key_links:
    - from: "src/app/(operator)/admin/clients/new/page.tsx"
      to: "src/components/admin/client-form.tsx"
      via: "imports ClientForm component"
      pattern: "import.*ClientForm"
    - from: "src/components/admin/client-form.tsx"
      to: "src/app/(operator)/admin/clients/actions.ts"
      via: "passes server action as form action"
      pattern: "action.*formAction"
    - from: "src/app/(operator)/admin/clients/actions.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient for user provisioning"
      pattern: "createAdminClient"
    - from: "src/app/(operator)/admin/clients/actions.ts"
      to: "src/lib/validations/client.ts"
      via: "Zod schema validation"
      pattern: "clientFormSchema.safeParse"
    - from: "src/app/(operator)/admin/clients/actions.ts"
      to: "src/lib/supabase/storage.ts"
      via: "uploadClientLogo for logo handling"
      pattern: "uploadClientLogo"
---

<objective>
Build the client creation flow: operator admin client list page, create client form with all fields (company name, email, password, color, logo, recruitment toggle, meeting URL, campaigns), and the server action that creates client + auth user + profile transactionally.

Purpose: This delivers OADM-01 (create client) and OADM-02 (associate campaigns). Operators can create fully configured client accounts.
Output: Client list page, create client page with form, server action with transactional creation + cleanup
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-operator-admin-core/02-RESEARCH.md
@.planning/phases/02-operator-admin-core/02-01-SUMMARY.md
@src/lib/supabase/admin.ts
@src/lib/validations/client.ts
@src/lib/instantly/client.ts
@src/lib/supabase/storage.ts
@src/types/database.ts
@src/types/auth.ts
@src/app/(operator)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server action for client creation and client list page</name>
  <files>
    src/app/(operator)/admin/clients/actions.ts
    src/app/(operator)/admin/page.tsx
  </files>
  <action>
    1. Create `src/app/(operator)/admin/clients/actions.ts` with 'use server' directive:

       **createClient(prevState: { error: string }, formData: FormData)**:
       - Parse and validate formData with clientFormSchema.safeParse. Extract companyName, email, password, primaryColor, isRecruitment, meetingUrl from the parsed data. Return { error } on validation failure with first error message.
       - Step 1: Insert client record into clients table (company_name, primary_color, is_recruitment, meeting_url). Select('id') single. On error return Dutch message.
       - Step 2: Create auth user via supabase.auth.admin.createUser({ email, password, email_confirm: true, app_metadata: { user_role: 'client', client_id: client.id } }). On error: DELETE the client record, return Dutch error.
       - Step 3: Insert profile record (id: authUser.user.id, user_role: 'client', client_id: client.id, display_name: companyName). On error: delete auth user via admin.deleteUser, delete client record, return Dutch error.
       - Step 4: Handle logo upload -- get 'logo' from formData as File. If file exists and file.size > 0, call uploadClientLogo(client.id, file). If error, update client logo_url to null (non-fatal, log warning). If success, update client.logo_url with returned url.
       - Step 5: Handle campaign associations -- get all 'campaign_ids' and 'campaign_names' from formData (getAll). If campaign_ids.length > 0, insert into client_campaigns (client_id, campaign_id, campaign_name). Non-fatal if this fails (log warning).
       - Final: revalidatePath('/admin'), redirect('/admin')
       - Use createAdminClient() for ALL database operations (bypasses RLS, needed for user creation)
       - All error messages in Dutch (e.g., "Klant aanmaken mislukt:", "Gebruiker aanmaken mislukt:", "Profiel aanmaken mislukt:")

    2. Update `src/app/(operator)/admin/page.tsx` to replace the placeholder:
       - Fetch all clients via admin client: supabase.from('clients').select('id, company_name, primary_color, logo_url, is_recruitment, created_at').order('created_at', { ascending: false })
       - Also fetch campaign counts: supabase.from('client_campaigns').select('client_id, id')
       - Display page title "Klanten beheer" with a "Nieuwe klant" link button to /admin/clients/new
       - Render a table or card list showing each client: company name, primary color swatch (small colored div), recruitment badge if applicable, campaign count, created date
       - Each client row links to /admin/clients/[clientId]/edit
       - Show "Nog geen klanten" message if list is empty
       - Use Tailwind for clean operator-admin styling
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - actions.ts exports createClient function
    - page.tsx imports from supabase/admin and renders client list
  </verify>
  <done>
    Server action handles transactional client creation with rollback on failure. Admin page shows client list with links to create/edit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client form component and new client page</name>
  <files>
    src/components/admin/client-form.tsx
    src/components/admin/campaign-selector.tsx
    src/components/admin/logo-upload.tsx
    src/components/admin/color-picker.tsx
    src/app/(operator)/admin/clients/new/page.tsx
  </files>
  <action>
    1. Create `src/components/admin/color-picker.tsx` ('use client'):
       - Simple component combining native `<input type="color">` with a text input showing the hex value
       - Props: name (string), defaultValue (string, default '#3B82F6')
       - Both inputs share the same name attribute for form submission
       - The color input updates the text input and vice versa via local state
       - Label: "Primaire kleur"

    2. Create `src/components/admin/logo-upload.tsx` ('use client'):
       - File input accepting image/png, image/jpeg, image/svg+xml, image/webp
       - Shows image preview when file selected (URL.createObjectURL)
       - If currentLogoUrl prop is provided, shows current logo
       - Name attribute: "logo" for FormData extraction
       - Label: "Logo"
       - Helper text: "PNG, JPEG, SVG of WebP. Maximaal 2MB."

    3. Create `src/components/admin/campaign-selector.tsx` ('use client'):
       - Props: campaigns: { id: string, name: string }[], selectedIds?: string[]
       - Renders a scrollable checkbox list of campaigns
       - Each checkbox has name="campaign_ids" value={campaign.id}
       - Hidden input with name="campaign_names" value={campaign.name} for each campaign
       - Shows campaign name next to each checkbox
       - "Geen campagnes gevonden" message if campaigns array is empty
       - Optional search/filter input at top that filters the list client-side
       - Label/legend: "Campagnes"

    4. Create `src/components/admin/client-form.tsx` ('use client'):
       - Props: action (server action function), defaultValues? (partial ClientFormValues), campaigns: { id: string, name: string }[], selectedCampaignIds?: string[], isEditing?: boolean
       - Uses useActionState to track form submission state and pending
       - Uses React Hook Form with zodResolver(clientFormSchema) for client-side validation (or clientEditSchema when isEditing)
       - Fields: companyName, email, password (with "laat leeg om niet te wijzigen" hint when editing), primaryColor (ColorPicker), logo (LogoUpload), isRecruitment (checkbox), meetingUrl
       - Integrates CampaignSelector and ColorPicker and LogoUpload components
       - Error display for server-side errors (state.error) in red alert box
       - Field-level errors from React Hook Form
       - Submit button: "Klant aanmaken" / "Bijwerken..." with pending state
       - All labels in Dutch: Bedrijfsnaam, E-mailadres, Wachtwoord, Primaire kleur, Logo, Recruitment klant, Afspraken URL, Campagnes
       - IMPORTANT: The form element must use the native action={formAction} pattern for server action submission. React Hook Form is used for client-side validation display only -- the actual form data flows through FormData to the server action. Register fields with RHF for validation but ensure name attributes match what the server action expects.

    5. Create `src/app/(operator)/admin/clients/new/page.tsx` (server component):
       - Fetch campaigns from Instantly API: import listCampaigns, call it in a try/catch. If INSTANTLY_API_KEY is not set or API fails, pass empty campaigns array (with a warning message displayed)
       - Import createClient action from '../actions'
       - Render page title "Nieuwe klant aanmaken" with a back link to /admin
       - Render ClientForm with action={createClient}, campaigns={campaigns}
       - Wrap in appropriate layout (max-w-2xl mx-auto for form width)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx next build` succeeds
    - All 5 component/page files exist
    - ClientForm imports and renders ColorPicker, LogoUpload, CampaignSelector
  </verify>
  <done>
    Complete client creation form with all required fields (company name, email, password, color picker, logo upload, recruitment toggle, meeting URL, campaign multi-select). New client page fetches campaigns from Instantly API and renders the form connected to the createClient server action.
  </done>
</task>

</tasks>

<verification>
- Operator admin page at /admin shows client list (or empty state)
- "Nieuwe klant" link navigates to /admin/clients/new
- Create form displays all 8 fields: company name, email, password, color, logo, recruitment, meeting URL, campaigns
- Form submission calls createClient server action
- Server action creates client + auth user + profile transactionally
- On failure at any step, prior steps are cleaned up
- After success, redirects to /admin
- All UI text in Dutch
</verification>

<success_criteria>
- `npx next build` passes
- /admin page renders client list from database
- /admin/clients/new renders full creation form
- createClient server action validates with Zod, creates records in order, cleans up on failure
</success_criteria>

<output>
After completion, create `.planning/phases/02-operator-admin-core/02-02-SUMMARY.md`
</output>
