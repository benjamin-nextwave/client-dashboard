---
phase: 02-operator-admin-core
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/(operator)/admin/clients/[clientId]/edit/page.tsx
  - src/app/(operator)/admin/clients/actions.ts
autonomous: false

must_haves:
  truths:
    - "Operator can navigate from client list to edit a specific client"
    - "Edit form pre-populates with existing client data (company name, color, recruitment toggle, meeting URL, current logo, selected campaigns)"
    - "Operator can change any field and save, including uploading a new logo or changing campaign associations"
    - "Password field is optional on edit -- only updates if filled in"
    - "After saving edits, operator is redirected back to the client list"
  artifacts:
    - path: "src/app/(operator)/admin/clients/[clientId]/edit/page.tsx"
      provides: "Edit client page with pre-populated form"
      contains: "ClientForm"
    - path: "src/app/(operator)/admin/clients/actions.ts"
      provides: "updateClient server action added to existing actions file"
      exports: ["createClient", "updateClient"]
  key_links:
    - from: "src/app/(operator)/admin/clients/[clientId]/edit/page.tsx"
      to: "src/components/admin/client-form.tsx"
      via: "imports shared ClientForm with isEditing=true"
      pattern: "ClientForm.*isEditing"
    - from: "src/app/(operator)/admin/clients/[clientId]/edit/page.tsx"
      to: "src/app/(operator)/admin/clients/actions.ts"
      via: "passes bound updateClient action"
      pattern: "updateClient.bind"
    - from: "src/app/(operator)/admin/clients/actions.ts"
      to: "src/lib/supabase/admin.ts"
      via: "admin client for updating user password and client records"
      pattern: "auth.admin.updateUserById"
---

<objective>
Build the client editing flow: edit client page with pre-populated form and updateClient server action. Then verify the complete OADM flow with a human checkpoint.

Purpose: This delivers OADM-03 (edit existing client settings) and completes the full operator admin CRUD cycle. The checkpoint verifies the end-to-end flow works visually and functionally.
Output: Edit client page, updateClient server action, verified working admin flow
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-operator-admin-core/02-RESEARCH.md
@.planning/phases/02-operator-admin-core/02-01-SUMMARY.md
@.planning/phases/02-operator-admin-core/02-02-SUMMARY.md
@src/app/(operator)/admin/clients/actions.ts
@src/components/admin/client-form.tsx
@src/lib/validations/client.ts
@src/lib/supabase/storage.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create updateClient server action and edit client page</name>
  <files>
    src/app/(operator)/admin/clients/actions.ts
    src/app/(operator)/admin/clients/[clientId]/edit/page.tsx
  </files>
  <action>
    1. Add `updateClient` to `src/app/(operator)/admin/clients/actions.ts`:
       - Signature: updateClient(clientId: string, prevState: { error: string }, formData: FormData)
       - Validate with clientEditSchema.safeParse
       - Update client record: company_name, primary_color, is_recruitment, meeting_url
       - If password is provided (non-empty string): look up the profile by client_id + user_role='client' to get the auth user id, then call supabase.auth.admin.updateUserById(profileId, { password })
       - If email changed (compare with formData 'originalEmail' hidden field): call supabase.auth.admin.updateUserById(profileId, { email: newEmail })
       - Handle logo: get 'logo' File from formData. If file exists and size > 0, call uploadClientLogo(clientId, file). If success, update clients.logo_url.
       - Handle campaigns: delete all existing client_campaigns for this clientId, then insert new associations from campaign_ids/campaign_names formData arrays
       - revalidatePath('/admin'), redirect('/admin')
       - All error messages in Dutch
       - Use createAdminClient() for all operations

    2. Create `src/app/(operator)/admin/clients/[clientId]/edit/page.tsx` (server component):
       - Extract clientId from params (Next.js 15 dynamic route: params is a Promise, await it)
       - Fetch client data: supabase.from('clients').select('*').eq('id', clientId).single()
       - Fetch client's current campaigns: supabase.from('client_campaigns').select('campaign_id, campaign_name').eq('client_id', clientId)
       - Fetch client's auth user email: supabase.from('profiles').select('id').eq('client_id', clientId).eq('user_role', 'client').single(), then supabase.auth.admin.getUserById(profile.id) to get email
       - Fetch available campaigns from Instantly API (try/catch, empty array on failure)
       - Use .bind() to partially apply clientId to updateClient: `const boundUpdate = updateClient.bind(null, clientId)`
       - Render page title "Klant bewerken: {companyName}" with back link to /admin
       - Render ClientForm with:
         - action={boundUpdate}
         - defaultValues: { companyName, email, primaryColor, isRecruitment, meetingUrl } from fetched data
         - campaigns from Instantly API
         - selectedCampaignIds from current client_campaigns
         - isEditing={true}
       - Include hidden input for originalEmail (for email change detection in server action)
       - If client not found, show "Klant niet gevonden" and link back to /admin
       - Wrap in max-w-2xl mx-auto layout
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx next build` succeeds
    - actions.ts exports both createClient and updateClient
    - edit/page.tsx exists and renders ClientForm with isEditing=true
  </verify>
  <done>
    Edit page loads existing client data, pre-populates the shared form, and saves changes via updateClient server action. Campaign associations are replaced on save. Password only updates if provided.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete operator admin CRUD flow for client management:
    - Client list page at /admin showing all clients
    - Create client form at /admin/clients/new with all fields
    - Edit client form at /admin/clients/[id]/edit with pre-populated data
    - Transactional client creation (client record + auth user + profile + logo + campaigns)
    - Client editing (update settings, optional password change, campaign re-association)
    - Storage bucket for logos, Instantly API integration for campaign selection
  </what-built>
  <how-to-verify>
    Prerequisites: Supabase running locally (`npx supabase start`), migrations applied (`npx supabase db reset`), INSTANTLY_API_KEY in .env.local (optional -- campaigns will be empty without it).

    1. Start dev server: `npm run dev`
    2. Log in as operator (use seed credentials)
    3. Navigate to /admin -- should see client list (seed clients from Phase 1)
    4. Click "Nieuwe klant" -- should see creation form with all fields
    5. Fill in form: company name, email, password, pick a color, toggle recruitment, enter a meeting URL
    6. If INSTANTLY_API_KEY is configured: campaign checkboxes should appear
    7. Submit form -- should redirect to /admin with new client in list
    8. Click the new client to edit -- form should be pre-populated with all entered data
    9. Change the primary color and company name, submit -- should redirect with updated values
    10. Verify the created client can log in: open incognito window, go to /login, use the email/password you set
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- /admin shows all clients with company name, color swatch, recruitment badge, campaign count
- /admin/clients/new creates a new client with all fields
- /admin/clients/[id]/edit loads and saves existing client data
- Newly created client can log in and sees the client dashboard
- Campaign associations persist across create and edit
- Logo upload works and URL is stored on client record
- All UI text is in Dutch
</verification>

<success_criteria>
- Full CRUD cycle works: list, create, edit
- Transactional creation with cleanup verified (no orphaned auth users)
- Created clients can authenticate and access client dashboard
- All Phase 2 success criteria met (OADM-01, OADM-02, OADM-03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-operator-admin-core/02-03-SUMMARY.md`
</output>
