---
phase: 05-inbox-reply-functionality
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/(client)/dashboard/inbox/[leadId]/page.tsx
  - src/app/(client)/dashboard/inbox/_components/thread-view.tsx
  - src/app/(client)/dashboard/inbox/_components/thread-message.tsx
  - src/app/(client)/dashboard/inbox/_components/reply-form.tsx
  - src/app/(client)/dashboard/inbox/_components/compose-modal.tsx
  - src/app/(client)/dashboard/inbox/_components/lead-contact-card.tsx
autonomous: true

must_haves:
  truths:
    - "Client can click a reply to open full conversation thread with all contact details"
    - "Client can reply to a lead directly from the dashboard, sent from the original sender account"
    - "Client can compose a new outbound email to any positive lead via Nieuwe Email button"
    - "For recruitment clients, inbox contact details include the vacancy/job posting URL"
  artifacts:
    - path: "src/app/(client)/dashboard/inbox/[leadId]/page.tsx"
      provides: "Server component for thread view with data fetching"
      contains: "force-dynamic"
    - path: "src/app/(client)/dashboard/inbox/_components/thread-view.tsx"
      provides: "Client component displaying email thread and contact card"
      contains: "ThreadView"
    - path: "src/app/(client)/dashboard/inbox/_components/reply-form.tsx"
      provides: "Reply form with react-hook-form and Zod validation"
      contains: "ReplyForm"
    - path: "src/app/(client)/dashboard/inbox/_components/compose-modal.tsx"
      provides: "Nieuwe Email compose modal"
      contains: "ComposeModal"
    - path: "src/app/(client)/dashboard/inbox/_components/lead-contact-card.tsx"
      provides: "Contact details sidebar with name, company, job title, email, LinkedIn, vacancy URL"
      contains: "LeadContactCard"
  key_links:
    - from: "src/app/(client)/dashboard/inbox/[leadId]/page.tsx"
      to: "src/lib/data/inbox-data.ts"
      via: "getLeadThread and getPositiveLeadsForInbox calls"
      pattern: "getLeadThread"
    - from: "src/app/(client)/dashboard/inbox/_components/reply-form.tsx"
      to: "src/lib/actions/inbox-actions.ts"
      via: "sendReply server action call"
      pattern: "sendReply"
    - from: "src/app/(client)/dashboard/inbox/_components/compose-modal.tsx"
      to: "src/lib/actions/inbox-actions.ts"
      via: "composeReply server action call"
      pattern: "composeReply"
---

<objective>
Thread view page with conversation display, reply form, compose modal, and contact details sidebar.

Purpose: Clients can read the full email conversation with a lead, see all contact details at a glance, and reply or compose new emails directly from the dashboard.

Output: Complete thread view at /dashboard/inbox/[leadId] with reply and compose functionality.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-inbox-reply-functionality/05-RESEARCH.md
@.planning/phases/05-inbox-reply-functionality/05-01-SUMMARY.md
@src/app/(client)/dashboard/page.tsx
@src/app/(client)/layout.tsx
@src/lib/data/inbox-data.ts
@src/lib/actions/inbox-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread view page and contact card component</name>
  <files>src/app/(client)/dashboard/inbox/[leadId]/page.tsx, src/app/(client)/dashboard/inbox/_components/lead-contact-card.tsx, src/app/(client)/dashboard/inbox/_components/thread-message.tsx</files>
  <action>
**1. Create `src/app/(client)/dashboard/inbox/[leadId]/page.tsx`:**

Server component following existing pattern:
- `export const dynamic = 'force-dynamic'`
- Get `params` from props (Next.js 15 dynamic route: `{ params: Promise<{ leadId: string }> }`)
- Call `getClientBranding()`, redirect if null
- Find the lead: query synced_leads by id using Supabase client, verify it belongs to this client (RLS handles this). Select: id, email, first_name, last_name, company_name, job_title, linkedin_url, vacancy_url, sender_account, client_has_replied, reply_subject.
- If lead not found, use `notFound()` from next/navigation
- Call `getLeadThread(client.id, lead.email)` to fetch the conversation thread
- Query `is_recruitment` from clients table (same as inbox list page pattern)
- Render layout: two-column on lg (thread left, contact card right), single column on mobile (contact card above thread)

```tsx
<div className="lg:grid lg:grid-cols-3 lg:gap-6">
  <div className="lg:col-span-2">
    <BackLink /> {/* Link back to /dashboard/inbox */}
    <ThreadView emails={emails} leadEmail={lead.email} senderAccount={lead.sender_account} leadId={lead.id} replySubject={lead.reply_subject} />
  </div>
  <div className="lg:col-span-1">
    <LeadContactCard lead={lead} isRecruitment={isRecruitment} />
  </div>
</div>
```

Include a back link at top: `<Link href="/dashboard/inbox" className="text-sm text-gray-500 hover:text-gray-700">‚Üê Terug naar inbox</Link>`

**2. Create `src/app/(client)/dashboard/inbox/_components/lead-contact-card.tsx`:**

Client component. Props: lead object (with name, company, job_title, email, linkedin_url, vacancy_url), isRecruitment boolean.

Card layout with:
- Full name (first_name + last_name) as heading
- Company name
- Job title
- Email (as mailto: link)
- LinkedIn URL (as external link with target="_blank", only show if non-null)
- Vacancy URL (only show if `isRecruitment && vacancy_url`, as external link)

Use a card container: `bg-white rounded-lg shadow p-6`. Each field on its own line with a label in gray-500 and value in gray-900.

If LinkedIn or vacancy URL is null, hide that row entirely (not "N/A").

**3. Create `src/app/(client)/dashboard/inbox/_components/thread-message.tsx`:**

Client component for a single email message bubble. Props: `{ fromAddress: string, toAddress: string, subject: string, bodyHtml: string | null, bodyText: string | null, timestamp: string, isFromClient: boolean }`.

Layout:
- Messages from the client's sender account: right-aligned with brand color background (use `bg-[var(--brand-color)]` with white text)
- Messages from the lead: left-aligned with gray-100 background
- Show from address, timestamp (formatted with date-fns `format(date, 'dd MMM yyyy, HH:mm', { locale: nl })`), and email body
- Render `bodyHtml` using `dangerouslySetInnerHTML` if available, fall back to `bodyText` in a `<pre>` with `whitespace-pre-wrap`
- Constrain max width to ~80% of container so messages don't span full width
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles. Verify the dynamic route [leadId] folder is created correctly.</verify>
  <done>Thread view page fetches lead + conversation, renders contact card sidebar with all details including LinkedIn/vacancy, and message bubbles styled by sender.</done>
</task>

<task type="auto">
  <name>Task 2: Thread view wrapper, reply form, and compose modal</name>
  <files>src/app/(client)/dashboard/inbox/_components/thread-view.tsx, src/app/(client)/dashboard/inbox/_components/reply-form.tsx, src/app/(client)/dashboard/inbox/_components/compose-modal.tsx</files>
  <action>
**1. Create `src/app/(client)/dashboard/inbox/_components/thread-view.tsx`:**

Client component (`'use client'`). Props: `{ emails: CachedEmail[], leadEmail: string, senderAccount: string, leadId: string, replySubject: string | null }`.

Where `CachedEmail` matches the cached_emails structure (import/define type locally or from inbox-data.ts).

Layout:
- Scrollable message container showing ThreadMessage components for each email
- At the bottom: ReplyForm component for quick reply
- "Nieuwe Email" button at the top-right that opens ComposeModal
- State: `showCompose` boolean for modal visibility

Determine `isFromClient` for each message: compare `email.from_address` to `senderAccount` (if they match, the message was sent by the agency on behalf of the client).

If no emails found, show: "Geen e-mails gevonden. De gespreksgeschiedenis wordt geladen..." with a note that emails are fetched on-demand.

**2. Create `src/app/(client)/dashboard/inbox/_components/reply-form.tsx`:**

Client component with react-hook-form + Zod validation. Props: `{ leadId: string, senderAccount: string, lastEmailId: string | null, replySubject: string | null }`.

Where `lastEmailId` is the ID of the most recent email in the thread (used as reply_to_uuid).

Form fields:
- Subject: pre-filled with `Re: ${replySubject}` (editable)
- Body: `<textarea>` for reply content (HTML will be wrapped in basic tags)

On submit:
- Convert plain text body to minimal HTML: `<p>${body.replace(/\n/g, '<br>')}</p>`
- Call `sendReply({ leadId, replyToUuid: lastEmailId, senderAccount, subject, bodyHtml })` from `@/lib/actions/inbox-actions`
- Show success toast or error message using a simple state-based notification (no toast library needed -- use a colored div that auto-dismisses)
- Clear form on success
- If `lastEmailId` is null, disable the form and show: "Kan niet antwoorden - geen eerdere e-mails gevonden."

Use Zod schema: `z.object({ subject: z.string().min(1, 'Onderwerp is verplicht'), body: z.string().min(1, 'Bericht is verplicht') })`

Use `useForm` with `zodResolver`. Use `useTransition` for the server action call to show loading state.

Submit button text: "Versturen" with loading state "Versturen..."

**3. Create `src/app/(client)/dashboard/inbox/_components/compose-modal.tsx`:**

Client component. Props: `{ isOpen: boolean, onClose: () => void, leadId: string, leadEmail: string, senderAccount: string }`.

Modal overlay with form:
- Subject field (empty, required)
- Body textarea (empty, required)

On submit:
- Convert body to HTML same as reply form
- Call `composeReply({ leadId, leadEmail, senderAccount, subject, bodyHtml })` from `@/lib/actions/inbox-actions`
- Show success/error feedback
- Close modal on success

Same Zod schema as reply form. Same useForm + zodResolver + useTransition pattern.

Modal: fixed overlay with centered white card, close button (X) top-right, title "Nieuwe Email". Click outside or X to close.

Button styling: Use brand color via `bg-[var(--brand-color)]` for submit buttons in both reply form and compose modal.
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles. Verify all imports from inbox-actions.ts resolve.</verify>
  <done>Thread view displays conversation with reply form at bottom and compose modal. Reply form sends via sendReply server action with proper threading. Compose modal sends via composeReply. Both use react-hook-form with Zod validation.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Thread view page at /dashboard/inbox/[leadId] fetches lead data and email thread
- Contact card shows name, company, job title, email, LinkedIn (if available), vacancy URL (if recruitment)
- Message bubbles are visually distinct for sender vs lead
- Reply form pre-fills subject, validates input, calls sendReply
- Compose modal opens from "Nieuwe Email" button, calls composeReply
- Both forms show loading state during submission
</verification>

<success_criteria>
- Client can view full conversation thread for any positive lead
- Contact card displays all available details including LinkedIn and vacancy URL for recruitment clients
- Reply form sends through original sender account with proper threading via reply_to_uuid
- Compose modal allows new email to existing thread
- Forms validate input and show success/error feedback
- Thread view is responsive (two-column on desktop, stacked on mobile)
</success_criteria>

<output>
After completion, create `.planning/phases/05-inbox-reply-functionality/05-03-SUMMARY.md`
</output>
