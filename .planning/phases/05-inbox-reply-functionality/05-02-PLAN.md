---
phase: 05-inbox-reply-functionality
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/(client)/dashboard/inbox/page.tsx
  - src/app/(client)/dashboard/inbox/_components/inbox-list.tsx
  - src/app/(client)/dashboard/inbox/_components/inbox-item.tsx
  - src/lib/actions/inbox-actions.ts
autonomous: true

must_haves:
  truths:
    - "Client sees a Gmail-style inbox showing only positive replies with sender name, company, subject, preview text, and date/time"
    - "Each lead displays status label: Nieuwe lead (unanswered) or In gesprek (conversation ongoing)"
    - "Inbox list is ordered by most recent activity"
  artifacts:
    - path: "src/app/(client)/dashboard/inbox/page.tsx"
      provides: "Server component fetching positive leads and rendering inbox"
      contains: "force-dynamic"
    - path: "src/app/(client)/dashboard/inbox/_components/inbox-list.tsx"
      provides: "Client component rendering list of inbox items with status badges"
      contains: "InboxList"
    - path: "src/app/(client)/dashboard/inbox/_components/inbox-item.tsx"
      provides: "Single inbox row with name, company, subject, preview, date, status badge"
      contains: "InboxItem"
    - path: "src/lib/actions/inbox-actions.ts"
      provides: "Server Actions for sendReply, composeReply"
      exports: ["sendReply", "composeReply"]
  key_links:
    - from: "src/app/(client)/dashboard/inbox/page.tsx"
      to: "src/lib/data/inbox-data.ts"
      via: "getPositiveLeadsForInbox call"
      pattern: "getPositiveLeadsForInbox"
    - from: "src/app/(client)/dashboard/inbox/_components/inbox-item.tsx"
      to: "src/app/(client)/dashboard/inbox/[leadId]/page.tsx"
      via: "Next.js Link to thread view"
      pattern: "href.*inbox/"
    - from: "src/lib/actions/inbox-actions.ts"
      to: "src/lib/instantly/client.ts"
      via: "replyToEmail API call"
      pattern: "replyToEmail"
---

<objective>
Inbox list page with Gmail-style layout showing positive leads with status badges, plus server actions for reply/compose operations.

Purpose: Clients can see all their positive leads in one place with clear visual status indicators, enabling them to quickly identify new leads that need attention.

Output: Working inbox list page at /dashboard/inbox with server actions ready for thread view to consume.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-inbox-reply-functionality/05-RESEARCH.md
@.planning/phases/05-inbox-reply-functionality/05-01-SUMMARY.md
@src/app/(client)/dashboard/page.tsx
@src/app/(client)/layout.tsx
@src/lib/client/get-client-branding.ts
@src/lib/data/inbox-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server actions for reply and compose operations</name>
  <files>src/lib/actions/inbox-actions.ts</files>
  <action>
Create `src/lib/actions/inbox-actions.ts` with `'use server'` directive. Two server actions:

**1. `sendReply(formData: SendReplyInput)`:**
- Input: `{ leadId: string, replyToUuid: string, senderAccount: string, subject: string, bodyHtml: string }`
- Validate user is authenticated via `supabase.auth.getUser()`
- Verify the lead belongs to this client by querying synced_leads with the leadId (RLS handles isolation)
- Call `replyToEmail({ eaccount: senderAccount, reply_to_uuid: replyToUuid, subject, body: { html: bodyHtml } })` from `@/lib/instantly/client`
- After success, update `synced_leads` SET `client_has_replied = true` WHERE `id = leadId` using admin client (to bypass SELECT-only RLS)
- Call `revalidatePath('/dashboard/inbox')`
- Return `{ success: true }` or `{ error: string }` on failure

**2. `composeReply(formData: ComposeReplyInput)`:**
- Input: `{ leadId: string, leadEmail: string, senderAccount: string, subject: string, bodyHtml: string }`
- Same auth check as sendReply
- Fetch the most recent email for this lead using `listEmails({ lead: leadEmail, sortOrder: 'desc', limit: 1 })` to get the reply_to_uuid
- If no prior email found, return `{ error: 'Geen eerdere e-mails gevonden voor deze lead.' }`
- Call `replyToEmail` with the found reply_to_uuid, using the provided subject and body
- Update `client_has_replied = true` on synced_leads
- Call `revalidatePath('/dashboard/inbox')`
- Return `{ success: true }` or `{ error: string }`

Use Zod schemas for input validation (import from 'zod'). Define `SendReplySchema` and `ComposeReplySchema` locally. Use try/catch around Instantly API calls.

Import `createClient` from `@/lib/supabase/server` for auth checks, `createAdminClient` from `@/lib/supabase/admin` for writes, and `replyToEmail`/`listEmails` from `@/lib/instantly/client`.
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles.</verify>
  <done>Two server actions exported: sendReply and composeReply, both with auth validation, Instantly API integration, and status tracking.</done>
</task>

<task type="auto">
  <name>Task 2: Inbox list page and components</name>
  <files>src/app/(client)/dashboard/inbox/page.tsx, src/app/(client)/dashboard/inbox/_components/inbox-list.tsx, src/app/(client)/dashboard/inbox/_components/inbox-item.tsx</files>
  <action>
**1. Replace `src/app/(client)/dashboard/inbox/page.tsx`** (currently placeholder):

Follow the exact pattern from `dashboard/page.tsx`:
- `export const dynamic = 'force-dynamic'`
- Async server component
- Call `getClientBranding()`, redirect to /login if null
- Call `getPositiveLeadsForInbox(client.id)` from `@/lib/data/inbox-data`
- Also fetch `is_recruitment` from the client record: extend the `getClientBranding` query OR query clients table directly for `is_recruitment` field using `client.id`

Actually, `getClientBranding` only returns `id, company_name, primary_color, logo_url`. Instead of modifying that shared function, query the `is_recruitment` field separately:
```typescript
const { data: clientInfo } = await supabase.from('clients').select('is_recruitment').eq('id', client.id).single()
```

Render:
```
<h1>Inbox</h1>
<p subtitle>Uw positieve leads en gesprekken</p>
<InboxList leads={positiveLeads} isRecruitment={clientInfo?.is_recruitment ?? false} />
```

If no leads, show empty state: "Geen positieve leads gevonden."

**2. Create `src/app/(client)/dashboard/inbox/_components/inbox-list.tsx`:**

Client component (`'use client'`). Props: `leads: InboxLead[]`, `isRecruitment: boolean`.

Renders a list/table of `InboxItem` components. Layout: vertical list with dividers, similar to Gmail inbox. Each row is clickable (wraps in Next.js Link to `/dashboard/inbox/${lead.id}`).

Add the InboxLead type import from `@/lib/data/inbox-data` (export the type from inbox-data.ts).

**3. Create `src/app/(client)/dashboard/inbox/_components/inbox-item.tsx`:**

Client component. Props: single `InboxLead` + `isRecruitment: boolean`.

Layout per row:
- Left: Status badge ("Nieuwe lead" green or "In gesprek" blue) based on `client_has_replied`
- Middle: Name (first_name + last_name), company_name below in smaller text, subject line, preview text truncated to 1 line
- Right: Date/time using `formatDistanceToNow` from date-fns with `{ addSuffix: true, locale: nl }` (import nl locale from date-fns/locale/nl)

Use Tailwind for styling: `hover:bg-gray-50` on rows, `truncate` for preview text, `font-semibold` for unread (Nieuwe lead) items.

Status badge: `<span className="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ...">`
- Nieuwe lead: `bg-green-100 text-green-800`
- In gesprek: `bg-blue-100 text-blue-800`
  </action>
  <verify>Run `npx tsc --noEmit` and verify the build compiles. Check that inbox page imports resolve correctly.</verify>
  <done>Inbox page at /dashboard/inbox renders a Gmail-style list of positive leads with status badges, sender info, subject, preview, and relative timestamps. Each row links to the thread view.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Inbox page uses force-dynamic and getClientBranding pattern
- Each inbox item shows: name, company, subject, preview text, date, status badge
- Status badges correctly show "Nieuwe lead" or "In gesprek"
- Server actions validate auth and use Instantly API correctly
- Rows link to /dashboard/inbox/[leadId]
</verification>

<success_criteria>
- /dashboard/inbox renders a list of positive leads from synced_leads
- Each lead shows sender name, company, subject, preview text, relative date
- Status labels distinguish "Nieuwe lead" vs "In gesprek"
- Server actions for sendReply and composeReply are ready for thread view
- Empty state message shown when no positive leads exist
</success_criteria>

<output>
After completion, create `.planning/phases/05-inbox-reply-functionality/05-02-SUMMARY.md`
</output>
