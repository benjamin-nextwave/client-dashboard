---
phase: 05-inbox-reply-functionality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000003_inbox_email_cache.sql
  - src/lib/instantly/types.ts
  - src/lib/instantly/client.ts
  - src/lib/instantly/sync.ts
  - src/lib/data/inbox-data.ts
autonomous: true

must_haves:
  truths:
    - "Positive leads can be queried with deduplication by email, returning contact details including LinkedIn and vacancy URL"
    - "Email threads can be fetched from Instantly API by lead email"
    - "Replies can be sent via Instantly API using reply_to_uuid and correct sender account"
    - "LinkedIn and vacancy URLs are extracted from payload during lead sync"
  artifacts:
    - path: "supabase/migrations/20260216000003_inbox_email_cache.sql"
      provides: "cached_emails table, linkedin_url/vacancy_url/client_has_replied/reply_subject/reply_content columns on synced_leads"
      contains: "CREATE TABLE public.cached_emails"
    - path: "src/lib/instantly/client.ts"
      provides: "listEmails and replyToEmail API functions"
      exports: ["listEmails", "replyToEmail"]
    - path: "src/lib/instantly/types.ts"
      provides: "InstantlyEmail type definition"
      contains: "InstantlyEmail"
    - path: "src/lib/instantly/sync.ts"
      provides: "LinkedIn/vacancy URL extraction during sync, reply_subject/reply_content population"
      contains: "linkedin_url"
    - path: "src/lib/data/inbox-data.ts"
      provides: "getPositiveLeadsForInbox and getLeadThread query functions"
      exports: ["getPositiveLeadsForInbox", "getLeadThread"]
  key_links:
    - from: "src/lib/data/inbox-data.ts"
      to: "supabase synced_leads table"
      via: "Supabase client query with interest_status = positive"
      pattern: "interest_status.*positive"
    - from: "src/lib/data/inbox-data.ts"
      to: "src/lib/instantly/client.ts"
      via: "listEmails call for on-demand thread fetching"
      pattern: "listEmails"
    - from: "src/lib/instantly/sync.ts"
      to: "synced_leads linkedin_url/vacancy_url columns"
      via: "extractPayloadField during lead sync"
      pattern: "extractPayloadField.*linkedin"
---

<objective>
Database migration, Instantly email API client, sync extension, and inbox data queries for Phase 5 inbox functionality.

Purpose: Establish the complete data foundation so inbox UI plans can query positive leads, fetch conversation threads, and send replies without building any data infrastructure.

Output: Migration SQL, extended API client with email endpoints, updated sync module, and inbox-specific data query functions.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-inbox-reply-functionality/05-RESEARCH.md
@.planning/phases/04-instantly-ai-integration-campaign-stats/04-01-SUMMARY.md
@supabase/migrations/20260216000002_synced_leads_and_analytics.sql
@src/lib/instantly/client.ts
@src/lib/instantly/types.ts
@src/lib/instantly/sync.ts
@src/lib/data/campaign-stats.ts
@src/lib/client/get-client-branding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for cached_emails table and synced_leads extensions</name>
  <files>supabase/migrations/20260216000003_inbox_email_cache.sql</files>
  <action>
Create migration file `supabase/migrations/20260216000003_inbox_email_cache.sql` with:

1. **Add columns to synced_leads:**
   - `linkedin_url TEXT` (extracted from payload during sync)
   - `vacancy_url TEXT` (extracted from payload during sync, for recruitment clients)
   - `client_has_replied BOOLEAN DEFAULT FALSE` (tracks "Nieuwe lead" vs "In gesprek" status)
   - `reply_subject TEXT` (latest reply subject for inbox list preview)
   - `reply_content TEXT` (latest reply content snippet for inbox list preview)

   Use `ALTER TABLE public.synced_leads ADD COLUMN IF NOT EXISTS` for each.

2. **Create cached_emails table:**
   ```sql
   CREATE TABLE public.cached_emails (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     client_id UUID NOT NULL REFERENCES public.clients(id) ON DELETE CASCADE,
     instantly_email_id TEXT NOT NULL UNIQUE,
     thread_id TEXT NOT NULL,
     lead_email TEXT NOT NULL,
     from_address TEXT NOT NULL,
     to_address TEXT NOT NULL,
     subject TEXT,
     body_text TEXT,
     body_html TEXT,
     is_reply BOOLEAN DEFAULT FALSE,
     sender_account TEXT,
     email_timestamp TIMESTAMPTZ,
     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   );
   ```

3. **Enable RLS on cached_emails** and create policies following the existing pattern:
   - Clients can SELECT own cached emails: `client_id::TEXT = (SELECT auth.jwt() ->> 'client_id')`
   - Operators can SELECT all: `(SELECT auth.jwt() ->> 'user_role') = 'operator'`

4. **Add indexes:**
   - `idx_cached_emails_client_lead ON public.cached_emails(client_id, lead_email)`
   - `idx_cached_emails_thread ON public.cached_emails(thread_id)`

Follow the exact RLS pattern from `20260216000002_synced_leads_and_analytics.sql` with `(SELECT auth.jwt())` subselect wrappers.
  </action>
  <verify>Run `npx supabase db diff` or check that the SQL file exists and is valid SQL syntax. Verify all ALTER TABLE statements use IF NOT EXISTS.</verify>
  <done>Migration file creates cached_emails table with RLS, adds 5 new columns to synced_leads, all using established RLS patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Instantly email API functions, sync extension, and inbox data queries</name>
  <files>src/lib/instantly/types.ts, src/lib/instantly/client.ts, src/lib/instantly/sync.ts, src/lib/data/inbox-data.ts</files>
  <action>
**1. Extend `src/lib/instantly/types.ts`** -- Add email type:

```typescript
export interface InstantlyEmail {
  id: string                      // UUID - used as reply_to_uuid
  thread_id: string
  from_address_email: string
  to_address_email_list: string
  subject: string
  body: { text?: string; html?: string }
  timestamp_created: string
  timestamp_email?: string
  is_reply: boolean
  campaign_id?: string
  subsequence_id?: string | null
  i_status?: number
  is_unread?: boolean
  attachments?: unknown[] | null
}
```

**2. Extend `src/lib/instantly/client.ts`** -- Add two new functions following the existing pattern (getHeaders(), BASE_URL, error handling, no-store cache):

- `listEmails(options?: ListEmailsOptions)`: GET /emails with optional filters: lead, eaccount, campaignId, limit, startingAfter, sortOrder, search. Returns `InstantlyListResponse<InstantlyEmail>`. Use URLSearchParams like existing functions.

- `replyToEmail(options: ReplyEmailOptions)`: POST /emails/reply with body: { eaccount, reply_to_uuid, subject, body: { html } }. Returns `InstantlyEmail`. Use JSON body like existing POST patterns.

Define interfaces for options inline (not exported) like the existing `ListCampaignsOptions` pattern.

**3. Extend `src/lib/instantly/sync.ts`** -- Update the lead row mapping inside `syncClientData` to:

- Extract `linkedin_url` using `extractPayloadField(payload, ['LinkedIn', 'linkedin', 'linkedin_url', 'LinkedIn URL', 'linkedIn', 'Linkedin'])`.
- Extract `vacancy_url` using `extractPayloadField(payload, ['Vacancy URL', 'vacancy_url', 'Vacature URL', 'vacature_url', 'Vacancy', 'vacature'])`.
- Add both to the upsert row object alongside existing fields.

Do NOT change `interest_status` logic or existing field mappings. Only add the two new fields to the leadRows map.

**4. Create `src/lib/data/inbox-data.ts`** -- New file with inbox query functions:

- `getPositiveLeadsForInbox(clientId: string)`: Query synced_leads where `interest_status = 'positive'`, ordered by `updated_at DESC`. Deduplicate by email (same pattern as `getContactList` in campaign-stats.ts). Return array of `InboxLead` objects with: id, email, first_name, last_name, company_name, job_title, linkedin_url, vacancy_url, sender_account, reply_date (from updated_at), reply_subject, reply_content, client_has_replied.

- `getLeadThread(clientId: string, leadEmail: string)`: First check cached_emails for this client+lead. If found and recent (within 5 minutes of most recent entry's created_at), return cached data. Otherwise, look up the sender_account(s) for this lead from synced_leads, call `listEmails({ lead: leadEmail, sortOrder: 'asc', limit: 100 })` from the Instantly client, cache results into cached_emails using admin client (upsert on instantly_email_id), and return the emails. Also update `client_has_replied` on synced_leads if any cached email has `from_address` matching a non-sender-account address.

Both functions use `createClient` from `@/lib/supabase/server` (for RLS-protected reads). The cache write in `getLeadThread` uses `createAdminClient` to bypass RLS for INSERT.

Define the `InboxLead` interface in this file (not exported from types.ts since it's a query-layer concern).
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Check that all imports resolve correctly.</verify>
  <done>Instantly client has listEmails and replyToEmail functions. Sync module extracts linkedin_url and vacancy_url. inbox-data.ts exports getPositiveLeadsForInbox and getLeadThread with caching.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- Migration SQL file exists at correct path
- `src/lib/instantly/client.ts` exports listEmails and replyToEmail
- `src/lib/data/inbox-data.ts` exports getPositiveLeadsForInbox and getLeadThread
- Sync module includes linkedin_url and vacancy_url in lead row mapping
</verification>

<success_criteria>
- cached_emails table migration with RLS is ready to deploy
- synced_leads has 5 new columns (linkedin_url, vacancy_url, client_has_replied, reply_subject, reply_content)
- Instantly API client supports email listing and reply operations
- Inbox data layer queries positive leads with deduplication and fetches/caches email threads
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-inbox-reply-functionality/05-01-SUMMARY.md`
</output>
