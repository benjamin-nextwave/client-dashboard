---
phase: 06-csv-import-export-dnc-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260217000001_csv_dnc_tables.sql
  - src/lib/validations/csv.ts
  - src/lib/validations/dnc.ts
autonomous: true

must_haves:
  truths:
    - "csv_uploads, csv_rows, and dnc_entries tables exist with correct columns"
    - "RLS policies enforce operator-only access on CSV tables and client-scoped access on DNC"
    - "PapaParse is installed and importable"
    - "Zod schemas validate all CSV and DNC input shapes"
  artifacts:
    - path: "supabase/migrations/20260217000001_csv_dnc_tables.sql"
      provides: "Database tables for CSV uploads, rows, and DNC entries with RLS"
      contains: "CREATE TABLE public.csv_uploads"
    - path: "src/lib/validations/csv.ts"
      provides: "Zod schemas for CSV batch insert, upload metadata"
      exports: ["CsvUploadMetaSchema", "CsvBatchInsertSchema"]
    - path: "src/lib/validations/dnc.ts"
      provides: "Zod schemas for DNC email, domain, and bulk import"
      exports: ["AddDncEmailSchema", "AddDncDomainSchema", "DncBulkImportSchema"]
  key_links:
    - from: "supabase/migrations/20260217000001_csv_dnc_tables.sql"
      to: "RLS policies"
      via: "auth.jwt() subselect pattern"
      pattern: "SELECT auth.jwt\\(\\)"
---

<objective>
Create the database foundation for CSV import/export and DNC management: three new tables (csv_uploads, csv_rows, dnc_entries) with RLS policies, install PapaParse, and create Zod validation schemas.

Purpose: All subsequent plans depend on these tables and schemas existing.
Output: Migration file, PapaParse installed, validation schemas for CSV and DNC inputs.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-csv-import-export-dnc-management/06-RESEARCH.md
@supabase/migrations/20260215000001_initial_schema.sql
@src/lib/validations/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for CSV and DNC tables</name>
  <files>supabase/migrations/20260217000001_csv_dnc_tables.sql</files>
  <action>
Create a single migration file with three tables following existing conventions (UUID PKs, timestamptz, CASCADE deletes):

1. `csv_uploads` table:
   - id UUID PK default gen_random_uuid()
   - client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE
   - filename TEXT NOT NULL
   - headers JSONB NOT NULL (stores array of column names)
   - total_rows INTEGER NOT NULL
   - email_column TEXT (operator-selected email column name, nullable for auto-detect)
   - uploaded_by UUID NOT NULL REFERENCES auth.users(id)
   - status TEXT NOT NULL DEFAULT 'uploading' CHECK (status IN ('uploading', 'ready', 'filtered', 'exported'))
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days')

2. `csv_rows` table:
   - id UUID PK default gen_random_uuid()
   - upload_id UUID NOT NULL REFERENCES csv_uploads(id) ON DELETE CASCADE
   - row_index INTEGER NOT NULL
   - data JSONB NOT NULL (stores original row as key-value pairs)
   - is_filtered BOOLEAN NOT NULL DEFAULT FALSE
   - filter_reason TEXT (nullable: 'email_match', 'domain_match', 'client_removed')
   - UNIQUE(upload_id, row_index)
   - INDEX on upload_id
   - GIN INDEX on data for email lookups

3. `dnc_entries` table:
   - id UUID PK default gen_random_uuid()
   - client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE
   - entry_type TEXT NOT NULL CHECK (entry_type IN ('email', 'domain'))
   - value TEXT NOT NULL (stored lowercase)
   - added_by UUID REFERENCES auth.users(id)
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - UNIQUE(client_id, entry_type, value)
   - INDEX on (client_id)
   - INDEX on (client_id, entry_type, value)

Enable RLS on all three tables. Create policies using the `(SELECT auth.jwt())` subselect pattern:

- csv_uploads: operators only (FOR ALL, user_role = 'operator')
- csv_rows: operators only (FOR ALL, user_role = 'operator')
- dnc_entries: clients manage own (FOR ALL, client_id matches jwt client_id), operators can SELECT all (FOR SELECT, user_role = 'operator')

Reference existing migration patterns in 20260215000001_initial_schema.sql for style consistency.
  </action>
  <verify>Run `npx supabase db push` (or check SQL syntax is valid by reviewing the file). Verify all three tables, indexes, and RLS policies are defined.</verify>
  <done>Migration file exists with csv_uploads, csv_rows, dnc_entries tables, all indexes, and RLS policies matching the auth.jwt() subselect pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Install PapaParse and create Zod validation schemas</name>
  <files>src/lib/validations/csv.ts, src/lib/validations/dnc.ts</files>
  <action>
1. Install PapaParse:
   ```bash
   npm install papaparse @types/papaparse
   ```

2. Create `src/lib/validations/csv.ts` with Dutch error messages (follow pattern from client.ts):
   - `CsvUploadMetaSchema`: { clientId: uuid, filename: string min 1, headers: array of strings min 1, totalRows: number int positive, emailColumn: string optional }
   - `CsvBatchInsertSchema`: { uploadId: uuid, startIndex: number int min 0, rows: array of Record<string, string> min 1 max 500 }
   - Export both schemas and their inferred types

3. Create `src/lib/validations/dnc.ts` with Dutch error messages:
   - `AddDncEmailSchema`: { email: string email 'Ongeldig e-mailadres' }
   - `AddDncDomainSchema`: { domain: string min 3 'Domein is te kort', regex /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/ 'Ongeldig domein' }
   - `DncBulkImportSchema`: { emails: array of string email min 1 max 10000 'Maximaal 10.000 adressen per import' }
   - Export all schemas and their inferred types
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation. Verify PapaParse is in package.json dependencies.</verify>
  <done>PapaParse installed, csv.ts exports CsvUploadMetaSchema and CsvBatchInsertSchema, dnc.ts exports AddDncEmailSchema, AddDncDomainSchema, and DncBulkImportSchema. All with Dutch error messages.</done>
</task>

</tasks>

<verification>
- Migration file contains CREATE TABLE for csv_uploads, csv_rows, dnc_entries
- All three tables have ENABLE ROW LEVEL SECURITY
- RLS policies use (SELECT auth.jwt()) pattern
- PapaParse appears in package.json
- Both validation files compile without TypeScript errors
- `npm run build` passes
</verification>

<success_criteria>
Database tables and validation schemas are ready for use by Plans 02 (DNC management) and 03 (CSV upload). PapaParse is available for client-side CSV parsing.
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-export-dnc-management/06-01-SUMMARY.md`
</output>
