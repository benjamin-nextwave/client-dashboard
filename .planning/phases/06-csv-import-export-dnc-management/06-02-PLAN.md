---
phase: 06-csv-import-export-dnc-management
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(client)/dashboard/dnc/page.tsx
  - src/app/(client)/dashboard/dnc/_components/dnc-list.tsx
  - src/app/(client)/dashboard/dnc/_components/dnc-add-form.tsx
  - src/app/(client)/dashboard/dnc/_components/dnc-csv-upload.tsx
  - src/lib/actions/dnc-actions.ts
autonomous: true

must_haves:
  truths:
    - "Client can manually add an email address to DNC list"
    - "Client can add a domain to DNC list"
    - "Client can upload a CSV to bulk-add emails to DNC list"
    - "Client can view all DNC entries (emails and domains) and remove them"
  artifacts:
    - path: "src/lib/actions/dnc-actions.ts"
      provides: "Server actions for DNC CRUD and bulk import"
      exports: ["addDncEmail", "addDncDomain", "removeDncEntry", "bulkImportDnc"]
    - path: "src/app/(client)/dashboard/dnc/page.tsx"
      provides: "DNC management page with all components"
      min_lines: 20
    - path: "src/app/(client)/dashboard/dnc/_components/dnc-list.tsx"
      provides: "Table of current DNC entries with remove buttons"
      min_lines: 30
    - path: "src/app/(client)/dashboard/dnc/_components/dnc-add-form.tsx"
      provides: "Forms for adding email and domain entries"
      min_lines: 40
    - path: "src/app/(client)/dashboard/dnc/_components/dnc-csv-upload.tsx"
      provides: "CSV upload component for bulk DNC import"
      min_lines: 30
  key_links:
    - from: "src/app/(client)/dashboard/dnc/page.tsx"
      to: "src/lib/actions/dnc-actions.ts"
      via: "server action imports"
      pattern: "import.*dnc-actions"
    - from: "src/lib/actions/dnc-actions.ts"
      to: "supabase dnc_entries table"
      via: "supabase client queries"
      pattern: "from\\('dnc_entries'\\)"
    - from: "src/app/(client)/dashboard/dnc/_components/dnc-csv-upload.tsx"
      to: "papaparse"
      via: "client-side CSV parsing"
      pattern: "import Papa from 'papaparse'"
---

<objective>
Build the client-facing DNC (Do Not Contact) management page where clients can add emails, add domains, bulk-import from CSV, view their list, and remove entries.

Purpose: Fulfills DNC-01 through DNC-04. Clients need self-service control over their exclusion list.
Output: Fully functional DNC page at /dashboard/dnc with all CRUD operations.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-csv-import-export-dnc-management/06-RESEARCH.md
@.planning/phases/06-csv-import-export-dnc-management/06-01-SUMMARY.md
@src/lib/actions/inbox-actions.ts
@src/lib/validations/dnc.ts
@src/app/(client)/dashboard/dnc/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: DNC server actions</name>
  <files>src/lib/actions/dnc-actions.ts</files>
  <action>
Create server actions file following the established pattern from inbox-actions.ts: 'use server', Zod validation, auth check via createClient(), client_id from JWT.

1. `addDncEmail(prevState, formData)`:
   - Validate with AddDncEmailSchema from dnc.ts
   - Get user via supabase.auth.getUser(), extract client_id from app_metadata
   - Insert into dnc_entries with entry_type='email', value=email.toLowerCase()
   - Handle duplicate (error code '23505') with Dutch message: 'Dit e-mailadres staat al op de DNC-lijst.'
   - revalidatePath('/dashboard/dnc')
   - Return { error: '' } on success, { error: message } on failure

2. `addDncDomain(prevState, formData)`:
   - Same pattern as addDncEmail but entry_type='domain'
   - Strip leading '@' if present (user might type @domein.nl)
   - Lowercase the value
   - Duplicate message: 'Dit domein staat al op de DNC-lijst.'

3. `removeDncEntry(entryId: string)`:
   - Validate entryId is non-empty
   - Auth check
   - Delete from dnc_entries where id=entryId (RLS ensures client can only delete own)
   - revalidatePath('/dashboard/dnc')
   - Return { success: true } or { error: message }

4. `bulkImportDnc(emails: string[])`:
   - Validate with DncBulkImportSchema
   - Auth check, get client_id
   - Map emails to lowercase, deduplicate with Set
   - Batch insert into dnc_entries (entry_type='email') using admin client for bulk performance
   - Use ON CONFLICT DO NOTHING to skip duplicates
   - revalidatePath('/dashboard/dnc')
   - Return { success: true, imported: count } or { error: message }

5. `getDncEntries()`:
   - Auth check, get client_id
   - Select from dnc_entries where client_id matches, ordered by created_at desc
   - Return typed array of entries
  </action>
  <verify>Run `npx tsc --noEmit` to verify all actions compile. Check imports resolve correctly.</verify>
  <done>Five server actions exported, all using Zod validation and auth checks, with Dutch error messages.</done>
</task>

<task type="auto">
  <name>Task 2: DNC page and components</name>
  <files>src/app/(client)/dashboard/dnc/page.tsx, src/app/(client)/dashboard/dnc/_components/dnc-list.tsx, src/app/(client)/dashboard/dnc/_components/dnc-add-form.tsx, src/app/(client)/dashboard/dnc/_components/dnc-csv-upload.tsx</files>
  <action>
1. **dnc-list.tsx** (client component):
   - Props: entries array of { id, entry_type, value, created_at }
   - Display as a table with columns: Type (E-mail/Domein), Waarde, Toegevoegd op, Actie
   - Each row has a "Verwijderen" button (red text, not destructive-looking)
   - On click, call removeDncEntry(id) and show state-based feedback (success/error div, auto-dismiss)
   - Show "Geen DNC-vermeldingen gevonden." when empty
   - Use Tailwind styling consistent with existing dashboard tables

2. **dnc-add-form.tsx** (client component):
   - Two sections side by side on lg, stacked on mobile
   - Left: "E-mailadres toevoegen" form with email input + "Toevoegen" button, uses useActionState with addDncEmail
   - Right: "Domein toevoegen" form with domain input (placeholder: "voorbeeld.nl") + "Toevoegen" button, uses useActionState with addDncDomain
   - Show state-based error feedback below each form (colored div, auto-dismiss pattern from Phase 5)
   - Clear input on success

3. **dnc-csv-upload.tsx** (client component):
   - 'use client', import Papa from 'papaparse'
   - File input accepting .csv files only
   - On file select: parse with PapaParse (header: true, skipEmptyLines: true)
   - Auto-detect email column: case-insensitive search for "email", "e-mail", "email_address", "emailaddress" in headers
   - If no email column found, show error: "Geen e-mailkolom gevonden in het CSV-bestand."
   - Extract all values from the email column, filter out empty strings
   - Show preview: "X e-mailadressen gevonden" with "Importeren" button
   - On import click: call bulkImportDnc with the extracted emails
   - Show progress/result: "X van Y adressen geimporteerd" or error
   - Reset file input after successful import

4. **page.tsx** (server component):
   - Replace stub content
   - Call getDncEntries() to fetch current entries
   - Render page title "Do Not Contact" with description "Beheer uw uitsluitingslijst voor e-mailadressen en domeinen."
   - Render DncAddForm component
   - Render DncCsvUpload component
   - Render DncList component with entries prop
   - Use consistent page layout (max-w, spacing) matching other dashboard pages
  </action>
  <verify>Run `npm run build` to verify all components compile. Verify page renders at /dashboard/dnc route.</verify>
  <done>DNC page shows add email form, add domain form, CSV bulk upload, and list of entries with remove buttons. All four DNC requirements (DNC-01 through DNC-04) are functional.</done>
</task>

</tasks>

<verification>
- DNC page loads at /dashboard/dnc without errors
- Email add form validates and inserts entries
- Domain add form strips @ prefix and lowercases
- CSV upload parses file, detects email column, and bulk imports
- List displays all entries with remove functionality
- `npm run build` passes
</verification>

<success_criteria>
Clients can add individual emails (DNC-01), add domains (DNC-02), bulk-import from CSV (DNC-03), and view/remove entries (DNC-04) from the /dashboard/dnc page.
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-export-dnc-management/06-02-SUMMARY.md`
</output>
