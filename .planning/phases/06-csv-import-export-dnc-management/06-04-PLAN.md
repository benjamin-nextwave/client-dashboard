---
phase: 06-csv-import-export-dnc-management
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/lib/actions/csv-actions.ts
  - src/app/api/csv/export/route.ts
  - src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-filter-export.tsx
  - src/app/(operator)/admin/clients/[clientId]/csv/page.tsx
  - src/app/api/cron/cleanup-csv/route.ts
autonomous: true

must_haves:
  truths:
    - "Operator can apply one-click DNC filtering that marks rows matching DNC emails and DNC domains (client-removed contacts deferred to Phase 7)"
    - "Operator can export a cleaned CSV with only non-filtered rows, preserving all original columns"
    - "DNC list is applied during CSV export filtering"
    - "Export downloads as a .csv file with proper Content-Disposition header"
    - "Expired CSV uploads are cleaned up automatically"
  artifacts:
    - path: "src/lib/actions/csv-actions.ts"
      provides: "applyDncFilter server action added to existing file"
      exports: ["applyDncFilter"]
    - path: "src/app/api/csv/export/route.ts"
      provides: "GET endpoint that generates and downloads filtered CSV"
      exports: ["GET"]
    - path: "src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-filter-export.tsx"
      provides: "UI with filter button, filter summary, and export button"
      min_lines: 40
    - path: "src/app/api/cron/cleanup-csv/route.ts"
      provides: "Cron endpoint to delete expired CSV uploads"
      exports: ["GET"]
  key_links:
    - from: "csv-filter-export.tsx"
      to: "src/lib/actions/csv-actions.ts"
      via: "applyDncFilter server action"
      pattern: "applyDncFilter"
    - from: "csv-filter-export.tsx"
      to: "/api/csv/export"
      via: "download link with uploadId param"
      pattern: "/api/csv/export\\?uploadId="
    - from: "src/app/api/csv/export/route.ts"
      to: "papaparse unparse"
      via: "CSV generation from JSONB rows"
      pattern: "Papa\\.unparse"
    - from: "src/lib/actions/csv-actions.ts applyDncFilter"
      to: "supabase csv_rows + dnc_entries"
      via: "SQL UPDATE with DNC matching"
      pattern: "dnc_entries|is_filtered"
---

<objective>
Add DNC filtering and CSV export capabilities: one-click filter button that marks rows matching DNC entries, export API route that generates clean CSV from non-filtered rows, and a cron job for expired upload cleanup.

Purpose: Fulfills OADM-05 (DNC filtering), OADM-06 (clean CSV export), and DNC-05 (DNC list applied during filtering).
Output: Complete CSV workflow -- upload, filter, export -- plus automated cleanup.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-csv-import-export-dnc-management/06-RESEARCH.md
@.planning/phases/06-csv-import-export-dnc-management/06-01-SUMMARY.md
@.planning/phases/06-csv-import-export-dnc-management/06-02-SUMMARY.md
@.planning/phases/06-csv-import-export-dnc-management/06-03-SUMMARY.md
@src/lib/actions/csv-actions.ts
@src/app/api/cron/sync-instantly/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DNC filter action and CSV export API route</name>
  <files>src/lib/actions/csv-actions.ts, src/app/api/csv/export/route.ts</files>
  <action>
1. **Add to csv-actions.ts** - `applyDncFilter(uploadId: string)`:
   - Validate uploadId is uuid
   - Use admin client
   - Fetch upload metadata to get client_id and email_column
   - If no email_column set, return { error: 'Geen e-mailkolom geselecteerd.' }
   - First, reset any previous filtering: UPDATE csv_rows SET is_filtered=FALSE, filter_reason=NULL WHERE upload_id=uploadId
   - Then apply DNC filtering using Supabase RPC or raw SQL via admin client. The filtering needs to:
     a. Match exact email addresses: lower(data->>email_column) matches lower(dnc_entries.value) where entry_type='email'
     b. Match domains: lower(split_part(data->>email_column, '@', 2)) matches lower(dnc_entries.value) where entry_type='domain'
   - Since Supabase JS client cannot do complex JOINed UPDATEs, create a PostgreSQL function `apply_dnc_filter(upload_uuid UUID)` in the SAME migration approach -- but since migration already ran, use admin client's `.rpc()` call. Alternative: execute three separate update queries:
     - Query 1: Get all DNC emails for this client_id, then update csv_rows where lower(data->>email_column) IN (email_list) to is_filtered=true, filter_reason='email_match'
     - Query 2: Get all DNC domains for this client_id, then fetch csv_rows for this upload where is_filtered=false, check domain match in TypeScript, and update matched rows
     - This TypeScript-side approach is acceptable for the domain matching since we already load the rows anyway
   - Actually, the simplest reliable approach: fetch all DNC entries for client, fetch all csv_rows for upload (only the email column value via data->>email_column), match in TypeScript, then batch-update matched row IDs. This avoids SQL complexity and works with Supabase JS client.
   - Implementation:
     a. Fetch DNC entries: dnc_emails (Set of lowercase emails), dnc_domains (Set of lowercase domains)
     b. Fetch all csv_rows for upload_id (just id, data->>email_column as email)
     c. For each row: check if lower(email) is in dnc_emails -> filter_reason='email_match'. Else check if domain part is in dnc_domains -> filter_reason='domain_match'
     d. Batch update matched rows (batch of 500): UPDATE csv_rows SET is_filtered=true, filter_reason=X WHERE id IN (ids)
   - Update csv_uploads status to 'filtered'
   - NOTE: "client-removed contacts" filtering (filter_reason='client_removed') will be added in Phase 7 when the contact preview/removal UI is implemented (PREV-03). The database schema already supports this filter_reason value â€” Phase 7 will extend applyDncFilter to also check for client-removed contacts.
   - Return { success: true, filtered: count, total: totalRows } or { error: string }

2. **Create export API route** at `src/app/api/csv/export/route.ts`:
   - export async function GET(request: Request)
   - Parse uploadId from URL searchParams
   - Validate uploadId exists and is uuid
   - Use admin client (operator endpoint)
   - Verify caller is operator by checking auth via createClient() -> getUser() -> user_role='operator'
   - Fetch upload metadata (headers, filename, client_id)
   - Fetch all csv_rows WHERE upload_id=uploadId AND is_filtered=false, ordered by row_index
   - Use PapaParse unparse() to generate CSV string from headers and row data
   - Return new Response(csvString) with headers:
     - Content-Type: text/csv; charset=utf-8
     - Content-Disposition: attachment; filename="{original_filename_without_ext}_gefilterd.csv"
   - Handle errors with JSON responses and appropriate status codes
  </action>
  <verify>Run `npx tsc --noEmit`. Verify export route file exists at correct path.</verify>
  <done>applyDncFilter action matches DNC emails and domains against CSV rows and marks them filtered. Export route generates CSV from non-filtered rows with download headers.</done>
</task>

<task type="auto">
  <name>Task 2: Filter/export UI and cleanup cron</name>
  <files>src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-filter-export.tsx, src/app/api/cron/cleanup-csv/route.ts, src/app/(operator)/admin/clients/[clientId]/csv/page.tsx</files>
  <action>
1. **csv-filter-export.tsx** (client component):
   - Props: uploadId (string), uploadStatus (string), totalRows (number), emailColumn (string | null)
   - Show only when upload status is 'ready' or 'filtered'
   - "DNC Filter Toepassen" button (primary color):
     - Disabled if no emailColumn is set (show warning: "Selecteer eerst een e-mailkolom")
     - On click: call applyDncFilter(uploadId)
     - Show loading state during filtering
     - On success: show summary "X van Y rijen gefilterd" in a green info box
   - After filtering (status='filtered'), show:
     - Filter summary: "Gefilterd: X rijen verwijderd (Y e-mail matches, Z domein matches)" -- get counts from the action result
     - "CSV Exporteren" button that triggers download:
       - Create an anchor element programmatically
       - Set href to `/api/csv/export?uploadId={uploadId}`
       - Set download attribute
       - Click it to trigger download
     - "Filter Resetten" small link button to re-run filter (which first resets)

2. **Update page.tsx** to integrate csv-filter-export.tsx:
   - For each upload card that has status 'ready' or 'filtered', render CsvFilterExport component
   - Pass uploadId, status, totalRows, emailColumn props

3. **Cleanup cron** at `src/app/api/cron/cleanup-csv/route.ts`:
   - Follow pattern from existing sync-instantly cron route
   - export async function GET(request: Request)
   - Verify CRON_SECRET from Authorization header (same pattern as sync-instantly)
   - Use admin client
   - Delete from csv_uploads where expires_at < NOW() -- CASCADE deletes csv_rows automatically
   - Return JSON response with { deleted: count }
   - Add comment noting this should be called daily via Vercel Cron
  </action>
  <verify>Run `npm run build` to verify full build passes. Verify cron route exists.</verify>
  <done>Operator can click "DNC Filter Toepassen" to mark matching rows, see filter summary, and click "CSV Exporteren" to download cleaned CSV. Expired uploads are cleaned up by cron.</done>
</task>

</tasks>

<verification>
- DNC filter marks rows with email_match and domain_match reasons
- Export generates a valid CSV with only non-filtered rows
- Downloaded CSV preserves all original columns in original order
- Filter can be re-applied (resets first)
- Cleanup cron deletes expired uploads
- `npm run build` passes
</verification>

<success_criteria>
Complete CSV workflow functional: upload (Plan 03) -> filter with DNC (this plan) -> export cleaned CSV (this plan). DNC list from Plan 02 is applied during filtering (DNC-05). Operator sees filter results and can download. Expired uploads are cleaned up automatically.
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-export-dnc-management/06-04-SUMMARY.md`
</output>
