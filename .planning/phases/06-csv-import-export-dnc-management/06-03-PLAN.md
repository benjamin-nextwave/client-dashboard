---
phase: 06-csv-import-export-dnc-management
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(operator)/admin/clients/[clientId]/csv/page.tsx
  - src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-upload.tsx
  - src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-preview.tsx
  - src/lib/actions/csv-actions.ts
autonomous: true

must_haves:
  truths:
    - "Operator can upload a CSV file for a specific client"
    - "CSV rows are stored with all original columns preserved in JSONB"
    - "Operator sees a preview table of uploaded rows"
    - "Upload handles 20k+ rows via client-side parsing and batched insert"
    - "Operator can select the email column if auto-detection fails"
  artifacts:
    - path: "src/lib/actions/csv-actions.ts"
      provides: "Server actions for CSV upload metadata creation and batch row insert"
      exports: ["createCsvUpload", "insertCsvBatch", "getCsvUploads", "getCsvUploadWithRows"]
    - path: "src/app/(operator)/admin/clients/[clientId]/csv/page.tsx"
      provides: "CSV management page for a specific client"
      min_lines: 20
    - path: "src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-upload.tsx"
      provides: "Client component with PapaParse parsing and batched upload"
      min_lines: 60
    - path: "src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-preview.tsx"
      provides: "Preview table showing uploaded CSV rows"
      min_lines: 30
  key_links:
    - from: "csv-upload.tsx"
      to: "src/lib/actions/csv-actions.ts"
      via: "server action calls for upload creation and batch insert"
      pattern: "createCsvUpload|insertCsvBatch"
    - from: "csv-upload.tsx"
      to: "papaparse"
      via: "client-side CSV parsing"
      pattern: "Papa\\.parse"
    - from: "src/lib/actions/csv-actions.ts"
      to: "supabase csv_uploads and csv_rows tables"
      via: "admin client queries"
      pattern: "from\\('csv_uploads'\\)|from\\('csv_rows'\\)"
---

<objective>
Build the operator CSV upload page where operators can upload a CSV for a specific client, with client-side PapaParse parsing, batched insert of rows into JSONB storage, email column detection, and a preview table.

Purpose: Fulfills OADM-04 (CSV upload with 7-day preview, preserving all original columns).
Output: Functional CSV upload page at /admin/clients/[clientId]/csv with preview.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-csv-import-export-dnc-management/06-RESEARCH.md
@.planning/phases/06-csv-import-export-dnc-management/06-01-SUMMARY.md
@src/app/(operator)/admin/clients/[clientId]/edit/page.tsx
@src/lib/validations/csv.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV server actions for upload and batch insert</name>
  <files>src/lib/actions/csv-actions.ts</files>
  <action>
Create server actions using admin client (operators bypass RLS via service_role). Follow pattern from existing actions.ts.

1. `createCsvUpload(input)`:
   - Validate with CsvUploadMetaSchema
   - Use createAdminClient() (operator actions use admin client)
   - Insert into csv_uploads: client_id, filename, headers (as JSONB array), total_rows, email_column (if provided), uploaded_by (from auth), status='uploading'
   - Return { uploadId: string } or { error: string }

2. `insertCsvBatch(input)`:
   - Validate with CsvBatchInsertSchema
   - Use admin client
   - Map rows to csv_rows records: { upload_id, row_index: startIndex + i, data: row }
   - Insert batch into csv_rows
   - After insert, count total rows for this upload_id
   - If count equals the upload's total_rows, update csv_uploads status to 'ready'
   - Return { success: true, insertedSoFar: count } or { error: string }

3. `getCsvUploads(clientId: string)`:
   - Validate clientId is uuid
   - Use admin client
   - Select from csv_uploads where client_id=clientId AND expires_at > NOW(), ordered by created_at desc
   - Return typed array of uploads

4. `getCsvUploadWithRows(uploadId: string, page?: number)`:
   - Validate uploadId
   - Use admin client
   - Fetch upload metadata from csv_uploads
   - Fetch first 50 rows from csv_rows where upload_id=uploadId, ordered by row_index, with pagination (offset = page * 50)
   - Return { upload, rows, totalRows } or { error: string }

5. `setEmailColumn(uploadId: string, emailColumn: string)`:
   - Update csv_uploads set email_column = emailColumn where id = uploadId
   - Return { success: true } or { error: string }
  </action>
  <verify>Run `npx tsc --noEmit` to verify compilation.</verify>
  <done>Five server actions for CSV operations exported, using admin client and Zod validation.</done>
</task>

<task type="auto">
  <name>Task 2: CSV upload page with PapaParse and preview</name>
  <files>src/app/(operator)/admin/clients/[clientId]/csv/page.tsx, src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-upload.tsx, src/app/(operator)/admin/clients/[clientId]/csv/_components/csv-preview.tsx</files>
  <action>
1. **csv-upload.tsx** (client component, 'use client'):
   - Props: clientId (string)
   - Import Papa from 'papaparse'
   - State: file, parsedData (headers + rows), uploading, progress (0-100), error, uploadId (after creation)
   - File input: accept=".csv", onChange triggers PapaParse parse with header:true, skipEmptyLines:true, transformHeader: h => h.trim()
   - After parse: store headers and rows in state, auto-detect email column (case-insensitive match for "email", "e-mail", "email_address", "emailaddress" in headers)
   - Show detected email column or dropdown to select from available headers if auto-detect fails
   - Show summary: "{rows.length} rijen gevonden, {headers.length} kolommen"
   - "Uploaden" button triggers upload sequence:
     a. Call createCsvUpload with clientId, filename, headers, totalRows, emailColumn
     b. Loop through rows in batches of 500: call insertCsvBatch with uploadId, startIndex, batch
     c. Update progress bar after each batch: Math.round((processed / total) * 100)%
     d. On complete, set uploadId for preview refresh
   - Show progress bar during upload (Tailwind styled div with percentage)
   - Show error messages in state-based feedback div (red, Dutch messages)
   - Disable file input and button during upload

2. **csv-preview.tsx** (client component):
   - Props: uploadId (string)
   - Fetch upload metadata and first 50 rows via getCsvUploadWithRows on mount (useEffect)
   - Display upload info: filename, status, total rows, email column, expires_at formatted
   - Horizontal-scrolling table showing first 50 rows with all columns from headers
   - Email column highlighted with a subtle background color
   - "Pagina laden" pagination if more than 50 rows (simple next/prev)
   - Show row count: "Toont 1-50 van {total}"
   - Status badge: uploading (geel), ready (groen), filtered (blauw), exported (grijs)

3. **page.tsx** (server component):
   - export const dynamic = 'force-dynamic'
   - Get clientId from params (await params pattern from edit page)
   - Fetch client name from clients table via admin client for page title
   - Fetch existing uploads via getCsvUploads(clientId)
   - Render page title: "CSV Beheer - {companyName}"
   - Back link to /admin/clients/{clientId}/edit
   - Render CsvUpload component with clientId prop
   - Render list of existing uploads as cards (filename, status, row count, uploaded date, expires date)
   - Each upload card links to or expands to show CsvPreview
   - Add a link to this CSV page from the client edit page (note: just add an anchor/Link element, do NOT modify the edit page structure)
  </action>
  <verify>Run `npm run build` to verify all components compile. Verify the /admin/clients/[clientId]/csv route exists.</verify>
  <done>Operator can navigate to CSV page for any client, upload a CSV file with progress bar, see parsed preview with all columns preserved, and email column is auto-detected or manually selectable.</done>
</task>

</tasks>

<verification>
- CSV page loads at /admin/clients/[clientId]/csv
- File selection triggers PapaParse parsing in browser (no server upload for parse)
- Upload creates metadata record then batches 500 rows at a time
- Progress bar updates during batch upload
- Preview table shows rows with all original columns
- Status updates to 'ready' when all batches complete
- `npm run build` passes
</verification>

<success_criteria>
Operator can upload a CSV for a client's 7-day preview, all original columns are preserved in JSONB, email column is detected, and a preview table shows the uploaded data. Handles 20k+ rows via client-side parsing and batched insert without timeout.
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-export-dnc-management/06-03-SUMMARY.md`
</output>
