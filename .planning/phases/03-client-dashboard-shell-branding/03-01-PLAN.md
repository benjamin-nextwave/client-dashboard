---
phase: 03-client-dashboard-shell-branding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - src/app/layout.tsx
  - next.config.ts
  - src/lib/client/get-client-branding.ts
  - src/components/client/client-logo.tsx
  - src/components/client/nav-item.tsx
  - src/components/client/sidebar-nav.tsx
  - src/app/(client)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Client dashboard displays the client's company logo in the sidebar navigation"
    - "Client dashboard applies the client's primary_color as the brand color throughout the UI"
    - "Each client sees only their own branding (CSS variable scoped to wrapper div, not :root)"
    - "Dashboard layout has a sidebar with navigation links for all 6 feature pages"
    - "All navigation labels and UI text are in Dutch"
  artifacts:
    - path: "src/app/globals.css"
      provides: "@theme inline with --color-brand CSS variable"
      contains: "@theme inline"
    - path: "src/lib/client/get-client-branding.ts"
      provides: "Server-side cached branding data fetcher"
      exports: ["getClientBranding"]
    - path: "src/components/client/sidebar-nav.tsx"
      provides: "Sidebar navigation with Dutch labels and sign-out"
      contains: "Overzicht"
    - path: "src/components/client/client-logo.tsx"
      provides: "Logo display with fallback to company initial"
      contains: "next/image"
    - path: "src/components/client/nav-item.tsx"
      provides: "Navigation item with active state via usePathname"
      contains: "usePathname"
    - path: "src/app/(client)/layout.tsx"
      provides: "Branded dashboard shell with CSS variable injection"
      contains: "--brand-color"
    - path: "next.config.ts"
      provides: "remotePatterns for Supabase Storage images"
      contains: "remotePatterns"
  key_links:
    - from: "src/app/(client)/layout.tsx"
      to: "src/lib/client/get-client-branding.ts"
      via: "getClientBranding() call"
      pattern: "getClientBranding"
    - from: "src/app/(client)/layout.tsx"
      to: "CSS --brand-color variable"
      via: "inline style attribute on wrapper div"
      pattern: "style.*--brand-color"
    - from: "src/app/globals.css"
      to: "Tailwind brand utilities"
      via: "@theme inline mapping --color-brand to --brand-color"
      pattern: "--color-brand.*var.*--brand-color"
    - from: "src/components/client/client-logo.tsx"
      to: "Supabase Storage"
      via: "next/image with remotePatterns"
      pattern: "Image.*src.*logoUrl"
---

<objective>
Build the branded client dashboard shell with sidebar navigation, per-tenant theming via Tailwind v4 CSS variables, and logo display.

Purpose: Transform the minimal client layout into a fully branded dashboard with sidebar navigation, company logo, and dynamic brand color -- the visual foundation for all client-facing features.
Output: Branded sidebar layout with 6 Dutch navigation links, per-client color theming, logo display with fallback, and next/image configuration for Supabase Storage.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-dashboard-shell-branding/03-RESEARCH.md

@src/app/globals.css
@src/app/layout.tsx
@src/app/(client)/layout.tsx
@src/app/(client)/dashboard/page.tsx
@next.config.ts
@src/types/database.ts
@src/lib/supabase/server.ts
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theming infrastructure and next/image configuration</name>
  <files>
    src/app/globals.css
    src/app/layout.tsx
    next.config.ts
    src/lib/client/get-client-branding.ts
  </files>
  <action>
    1. **globals.css** -- Add `@theme inline` block after the existing `@import "tailwindcss"` line:
       ```css
       @theme inline {
         --color-brand: var(--brand-color, #3B82F6);
       }
       ```
       This creates Tailwind utilities `bg-brand`, `text-brand`, `border-brand`, `ring-brand` etc. that resolve to the `--brand-color` CSS variable at runtime. The fallback `#3B82F6` (blue) is used if no variable is set.

    2. **src/app/layout.tsx** -- Change `<html lang="en">` to `<html lang="nl">` for Dutch language accessibility. No other changes to this file.

    3. **next.config.ts** -- Add `images.remotePatterns` for Supabase Storage URLs. Extract hostname from `NEXT_PUBLIC_SUPABASE_URL` env var with try/catch for build-time safety:
       ```typescript
       const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ?? '';
       let supabaseHostname = '';
       try {
         supabaseHostname = new URL(supabaseUrl).hostname;
       } catch {
         // env var not set during build
       }
       ```
       Add to config:
       ```typescript
       images: {
         remotePatterns: supabaseHostname
           ? [{ protocol: 'https' as const, hostname: supabaseHostname, pathname: '/storage/v1/object/public/**' }]
           : [],
       },
       ```
       Keep the existing `experimental.serverActions.bodySizeLimit: '3mb'`.

    4. **src/lib/client/get-client-branding.ts** -- Create server-side helper using React `cache()` for request deduplication:
       - Import `createClient` from `@/lib/supabase/server` and `cache` from `react`
       - Export `getClientBranding` wrapped in `cache(async () => { ... })`
       - Inside: call `supabase.auth.getUser()`, extract `client_id` from `user.app_metadata`
       - Query `clients` table: `.select('id, company_name, primary_color, logo_url').eq('id', clientId).single()`
       - Return `client` data or `null` if no user/clientId
       - This uses the RLS-scoped server client so clients can only read their own row
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors. Verify `globals.css` contains `@theme inline`, `layout.tsx` has `lang="nl"`, `next.config.ts` has `remotePatterns`, `get-client-branding.ts` exports `getClientBranding`.
  </verify>
  <done>
    Tailwind brand color utilities available via CSS variable, html lang set to Dutch, next/image configured for Supabase Storage, branding helper created with request-level caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar components and layout rewrite</name>
  <files>
    src/components/client/client-logo.tsx
    src/components/client/nav-item.tsx
    src/components/client/sidebar-nav.tsx
    src/app/(client)/layout.tsx
  </files>
  <action>
    1. **src/components/client/client-logo.tsx** -- Server component (no 'use client'):
       - Accept props: `{ logoUrl: string | null; companyName: string }`
       - If `logoUrl` is null: render a `<div>` with `className="flex h-10 w-10 items-center justify-center rounded-full bg-brand text-white font-bold text-lg"` showing `companyName.charAt(0).toUpperCase()` as fallback
       - If `logoUrl` exists: render `<Image>` from `next/image` with `src={logoUrl}`, `alt={companyName + ' logo'}`, `width={160}`, `height={40}`, `className="h-10 w-auto object-contain"`. Add `unoptimized={logoUrl.endsWith('.svg')}` for SVG support.

    2. **src/components/client/nav-item.tsx** -- Client component ('use client'):
       - Accept props: `{ href: string; label: string; icon: React.ReactNode }`
       - Use `usePathname()` from `next/navigation` for active state detection
       - Active when `pathname === href` (exact match for /dashboard) OR `pathname.startsWith(href) && href !== '/dashboard'` (prefix match for sub-pages)
       - Active state: `bg-brand/10 text-brand font-semibold`
       - Inactive state: `text-gray-600 hover:bg-gray-100 hover:text-gray-900`
       - Render `<Link>` from `next/link` with flex layout, icon on left, label on right, `gap-3`, `rounded-lg px-3 py-2 text-sm transition-colors`

    3. **src/components/client/sidebar-nav.tsx** -- Client component ('use client') because it uses NavItem which needs usePathname:
       - Accept props: `{ companyName: string; logoUrl: string | null }`
       - Define `NAV_ITEMS` array with 6 items, each with `href`, `label`, and inline SVG `icon`:
         - `/dashboard` / "Overzicht" / house icon (simple SVG path)
         - `/dashboard/inbox` / "Inbox" / inbox/envelope icon
         - `/dashboard/verzonden` / "Verzonden" / send/paper-plane icon
         - `/dashboard/voorkeuren` / "Voorkeuren" / settings/gear icon
         - `/dashboard/dnc` / "DNC" / shield/block icon
         - `/dashboard/afspraken` / "Afspraken" / calendar icon
       - Use simple inline SVGs (5-6 path elements each, no icon library dependency). Each icon: `<svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">` with appropriate path.
       - Layout: `<aside className="flex w-64 flex-col border-r border-gray-200 bg-white">`
         - Top: logo area with `ClientLogo` component, `h-16 border-b px-4 flex items-center`
         - Middle: `<nav className="flex-1 space-y-1 px-3 py-4">` with mapped NavItems
         - Bottom: sign-out section with `border-t p-3`, form posting to sign-out server action
       - For sign-out: use a `<form>` with `action` attribute. Import and use a server action from the layout or create inline. The simplest approach: the form action will be passed as a prop `signOutAction` of type `() => Promise<void>` so the layout can pass the server action down.
       - Actually, since this is 'use client', use `action={signOutAction}` where `signOutAction` is a prop. The server action is defined in the layout (server component) and passed down.

    4. **src/app/(client)/layout.tsx** -- Complete rewrite:
       - Keep it as a server component (no 'use client')
       - Import `getClientBranding` from `@/lib/client/get-client-branding`
       - Import `SidebarNav` from `@/components/client/sidebar-nav`
       - Import `redirect` from `next/navigation` and `createClient` from `@/lib/supabase/server`
       - Define `signOut` server action ('use server') that calls `supabase.auth.signOut()` then `redirect('/login')` -- keep existing pattern
       - In the component body: `const client = await getClientBranding()`. If `!client`, call `redirect('/login')`
       - Set `const brandColor = client.primary_color || '#3B82F6'`
       - Return:
         ```tsx
         <div className="flex min-h-screen bg-gray-50" style={{ '--brand-color': brandColor } as React.CSSProperties}>
           <SidebarNav companyName={client.company_name} logoUrl={client.logo_url} signOutAction={signOut} />
           <main className="flex-1 px-6 py-8 overflow-auto">
             {children}
           </main>
         </div>
         ```
       - The `--brand-color` CSS variable on this wrapper div cascades to ALL children, making `bg-brand`, `text-brand` etc. resolve to the client's color. Set on wrapper div NOT on :root to prevent leakage between clients.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- builds successfully. Verify all 4 component files exist with correct imports and exports.
  </verify>
  <done>
    Client layout shows sidebar with company logo (or initial fallback), 6 Dutch navigation links with active state highlighting using brand color, sign-out button, and main content area. Brand color flows through CSS variable to all Tailwind brand utilities.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `globals.css` contains `@theme inline` with `--color-brand`
4. `layout.tsx` (root) has `lang="nl"`
5. `next.config.ts` has `remotePatterns` for Supabase Storage
6. `(client)/layout.tsx` sets `--brand-color` via inline style on wrapper div (not :root)
7. `sidebar-nav.tsx` contains all 6 Dutch nav labels: Overzicht, Inbox, Verzonden, Voorkeuren, DNC, Afspraken
8. `client-logo.tsx` handles null `logoUrl` with initial fallback
9. `nav-item.tsx` uses `usePathname()` for active state
</verification>

<success_criteria>
- Brand color CSS variable system works end-to-end: DB hex value -> layout inline style -> @theme inline -> Tailwind utilities
- Sidebar navigation renders with all 6 Dutch-labeled links
- Logo displays via next/image or falls back to branded initial circle
- Active navigation state highlights current page with brand color
- Sign-out works from sidebar
- No CSS variable leakage (scoped to wrapper div)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-dashboard-shell-branding/03-01-SUMMARY.md`
</output>
