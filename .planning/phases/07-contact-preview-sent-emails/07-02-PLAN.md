---
phase: 07-contact-preview-sent-emails
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/data/sent-data.ts
  - src/app/(client)/dashboard/verzonden/page.tsx
  - src/app/(client)/dashboard/verzonden/_components/sent-email-list.tsx
  - src/app/(client)/dashboard/verzonden/[emailId]/page.tsx
  - src/app/(client)/dashboard/verzonden/_components/sent-email-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Client sees a list of all outgoing campaign emails with recipient, subject, and date"
    - "Client can click a sent email to view full details (recipient, subject, body, date/time)"
    - "Sent emails page has no reply, forward, or compose actions"
    - "Only outbound emails appear (no inbound replies)"
  artifacts:
    - path: "src/lib/data/sent-data.ts"
      provides: "getSentEmails and getSentEmailDetail query functions"
      exports: ["getSentEmails", "getSentEmailDetail"]
    - path: "src/app/(client)/dashboard/verzonden/page.tsx"
      provides: "Sent emails list page (server component)"
    - path: "src/app/(client)/dashboard/verzonden/_components/sent-email-list.tsx"
      provides: "Client component rendering sent email rows with click navigation"
    - path: "src/app/(client)/dashboard/verzonden/[emailId]/page.tsx"
      provides: "Sent email detail page (server component)"
    - path: "src/app/(client)/dashboard/verzonden/_components/sent-email-detail.tsx"
      provides: "Read-only email detail display"
  key_links:
    - from: "src/app/(client)/dashboard/verzonden/page.tsx"
      to: "src/lib/data/sent-data.ts"
      via: "getSentEmails call"
      pattern: "getSentEmails"
    - from: "src/app/(client)/dashboard/verzonden/[emailId]/page.tsx"
      to: "src/lib/data/sent-data.ts"
      via: "getSentEmailDetail call"
      pattern: "getSentEmailDetail"
    - from: "src/app/(client)/dashboard/verzonden/_components/sent-email-list.tsx"
      to: "/dashboard/verzonden/[emailId]"
      via: "router.push or Link navigation"
      pattern: "verzonden/"
---

<objective>
Read-only sent emails mailbox where clients view all outgoing campaign emails and click to see full details. No reply, forward, or compose actions.

Purpose: Gives clients visibility into all sent campaign emails without interactive email features, fulfilling SENT-01, SENT-02, SENT-03.
Output: Working sent emails page at /dashboard/verzonden with list and detail views.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-contact-preview-sent-emails/07-RESEARCH.md
@src/lib/data/inbox-data.ts
@src/lib/instantly/client.ts
@src/lib/instantly/types.ts
@src/app/(client)/dashboard/inbox/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sent emails data layer and list page</name>
  <files>
    src/lib/data/sent-data.ts
    src/app/(client)/dashboard/verzonden/page.tsx
    src/app/(client)/dashboard/verzonden/_components/sent-email-list.tsx
  </files>
  <action>
1. Create `src/lib/data/sent-data.ts`:
   - Import createClient from @/lib/supabase/server, createAdminClient from @/lib/supabase/admin, listEmails from @/lib/instantly/client
   - Export interface SentEmail { id: string; toAddress: string; fromAddress: string; subject: string | null; previewText: string | null; sentAt: string | null }
   - Export interface SentEmailDetail extends SentEmail { bodyHtml: string | null; bodyText: string | null }
   - Export async function getSentEmails(clientId: string): Promise<SentEmail[]>
     - Query cached_emails with RLS client: .select('id, to_address, from_address, subject, body_text, email_timestamp, sender_account').eq('client_id', clientId).not('sender_account', 'is', null).order('email_timestamp', { ascending: false })
     - Filter: only include rows where sender_account is NOT null (outbound emails have sender_account set, inbound replies do not). This is the reliable outbound indicator from the inbox-data.ts caching logic.
     - Map to SentEmail: previewText = first 120 chars of body_text, trimmed
     - If cached results are empty or fewer than expected, trigger a cache population:
       - Fetch client's campaign IDs from client_campaigns table
       - For each campaign, call listEmails({ campaign_id, limit: 50, sortOrder: 'desc' }) from Instantly API
       - Cache results using admin client upsert to cached_emails (same pattern as getLeadThread)
       - Re-query cached_emails and return mapped results
     - Note: the cache population is a one-time warm-up; subsequent visits use cached data
   - Export async function getSentEmailDetail(clientId: string, emailId: string): Promise<SentEmailDetail | null>
     - Query cached_emails: .select('*').eq('client_id', clientId).eq('id', emailId).single()
     - Return null if error or no data
     - Map to SentEmailDetail including bodyHtml and bodyText

2. Replace `src/app/(client)/dashboard/verzonden/page.tsx` (currently a stub):
   - export const dynamic = 'force-dynamic'
   - Server component: call getClientBranding() for auth (redirect to /login if null)
   - Call getSentEmails(client.id)
   - Render heading "Verzonden" with subtitle "Alle verzonden campagne e-mails."
   - If emails empty: "Geen verzonden e-mails gevonden." message
   - Otherwise render <SentEmailList emails={emails} />

3. Create `src/app/(client)/dashboard/verzonden/_components/sent-email-list.tsx`:
   - 'use client' directive
   - Import { useRouter } from 'next/navigation', { format } from 'date-fns', { nl } from 'date-fns/locale'
   - Props: { emails: SentEmail[] }
   - Render a table-like list (similar to inbox page style):
     - Each row shows: recipient (toAddress), subject (or "Geen onderwerp"), date (formatted with date-fns nl locale: 'd MMM yyyy HH:mm')
     - Entire row is clickable: router.push(`/dashboard/verzonden/${email.id}`)
     - Hover state: bg-gray-50 transition
     - Preview text shown below subject in text-sm text-gray-500, truncated
   - NO reply, forward, compose buttons anywhere. Read-only list only.
   - Style consistently with inbox list (divide-y, rounded border, cursor-pointer rows)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles. Verify no reply/compose/forward references in sent-email-list.tsx.</verify>
  <done>Sent emails list page renders at /dashboard/verzonden showing outbound-only emails. Each row is clickable. No interactive email actions present.</done>
</task>

<task type="auto">
  <name>Task 2: Sent email detail page</name>
  <files>
    src/app/(client)/dashboard/verzonden/[emailId]/page.tsx
    src/app/(client)/dashboard/verzonden/_components/sent-email-detail.tsx
  </files>
  <action>
1. Create `src/app/(client)/dashboard/verzonden/[emailId]/page.tsx`:
   - export const dynamic = 'force-dynamic'
   - Server component with params: { emailId: string }
   - Call getClientBranding() for auth (redirect to /login if null)
   - Call getSentEmailDetail(client.id, emailId)
   - If null: redirect to /dashboard/verzonden (email not found)
   - Render <SentEmailDetail email={detail} />

2. Create `src/app/(client)/dashboard/verzonden/_components/sent-email-detail.tsx`:
   - Can be a server component (no interactivity needed) or simple client component
   - Props: { email: SentEmailDetail }
   - Layout:
     - Back link: "Terug naar verzonden" linking to /dashboard/verzonden (use Next.js Link)
     - Header section with:
       - Subject (text-xl font-semibold) or "Geen onderwerp"
       - From: email.fromAddress
       - Aan: email.toAddress (Dutch "Aan" = "To")
       - Datum: formatted with date-fns nl locale ('d MMMM yyyy HH:mm')
     - Divider (border-t)
     - Body section: render email.bodyHtml in a div with dangerouslySetInnerHTML if available, otherwise email.bodyText in a <pre> with whitespace-pre-wrap
     - Wrap body HTML in a div with prose classes for reasonable email rendering
   - CRITICAL: No reply button, no forward button, no compose button, no form elements anywhere. This is strictly read-only per SENT-03.
   - Style with card-like container (bg-white rounded-lg shadow-sm border p-6)
  </action>
  <verify>Run `npx next build` to verify build succeeds. Grep sent-email-detail.tsx for "reply|forward|compose|form|button" - should find zero matches (except in comments if any).</verify>
  <done>Sent email detail page renders at /dashboard/verzonden/[emailId] showing full email (recipient, subject, body, date). No interactive actions. Back link returns to list.</done>
</task>

</tasks>

<verification>
- `npx next build` passes without errors
- Verzonden page exists at /dashboard/verzonden (replaces stub)
- Detail page exists at /dashboard/verzonden/[emailId]
- No reply, forward, or compose actions in any sent email component
- Only outbound emails displayed (sender_account IS NOT NULL filter)
</verification>

<success_criteria>
- SENT-01: Client sees list of all outgoing campaign emails with recipient, subject, preview, and date
- SENT-02: Client can click to view full email detail (recipient, from, subject, body, date/time)
- SENT-03: Zero interactive email actions (no reply, forward, compose buttons/forms) anywhere in sent email pages
</success_criteria>

<output>
After completion, create `.planning/phases/07-contact-preview-sent-emails/07-02-SUMMARY.md`
</output>
