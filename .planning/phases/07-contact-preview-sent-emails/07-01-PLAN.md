---
phase: 07-contact-preview-sent-emails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260218000001_preview_exclusions.sql
  - src/lib/data/preview-data.ts
  - src/lib/actions/preview-actions.ts
  - src/app/(client)/dashboard/voorvertoning/page.tsx
  - src/app/(client)/dashboard/voorvertoning/_components/preview-table.tsx
  - src/components/client/sidebar-nav.tsx
  - src/lib/actions/csv-actions.ts
autonomous: true

must_haves:
  truths:
    - "Client sees a table of upcoming contacts (not_yet_emailed) with full name, company name, sector/industry, job title columns"
    - "Client can click a delete button to remove a contact from the preview"
    - "Removed contacts do not appear in the preview table after refresh"
    - "Removed contacts are filtered out during operator DNC filtering export"
    - "Client can navigate to the preview page from the sidebar"
  artifacts:
    - path: "supabase/migrations/20260218000001_preview_exclusions.sql"
      provides: "is_excluded column on synced_leads, partial index, UPDATE RLS policy"
      contains: "is_excluded"
    - path: "src/lib/data/preview-data.ts"
      provides: "getPreviewContacts query function"
      exports: ["getPreviewContacts"]
    - path: "src/lib/actions/preview-actions.ts"
      provides: "excludeContact server action"
      exports: ["excludeContact"]
    - path: "src/app/(client)/dashboard/voorvertoning/page.tsx"
      provides: "Preview page server component"
    - path: "src/app/(client)/dashboard/voorvertoning/_components/preview-table.tsx"
      provides: "Interactive table with delete buttons"
    - path: "src/lib/actions/csv-actions.ts"
      provides: "applyDncFilter extended with is_excluded check"
      contains: "is_excluded"
  key_links:
    - from: "src/app/(client)/dashboard/voorvertoning/page.tsx"
      to: "src/lib/data/preview-data.ts"
      via: "getPreviewContacts call"
      pattern: "getPreviewContacts"
    - from: "src/app/(client)/dashboard/voorvertoning/_components/preview-table.tsx"
      to: "src/lib/actions/preview-actions.ts"
      via: "excludeContact server action call"
      pattern: "excludeContact"
    - from: "src/lib/actions/csv-actions.ts"
      to: "synced_leads.is_excluded"
      via: "additional DNC filter check"
      pattern: "is_excluded"
---

<objective>
Contact preview page where clients see upcoming (not_yet_emailed) contacts in a table and can remove individual contacts. Removed contacts integrate with operator DNC filtering.

Purpose: Gives clients transparency and control over who gets contacted, fulfilling PREV-01, PREV-02, PREV-03.
Output: Working preview page at /dashboard/voorvertoning with delete capability and DNC integration.
</objective>

<execution_context>
@C:\Users\bstei\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bstei\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-contact-preview-sent-emails/07-RESEARCH.md
@src/lib/data/inbox-data.ts
@src/lib/data/campaign-stats.ts
@src/lib/actions/csv-actions.ts
@src/lib/actions/dnc-actions.ts
@src/app/(client)/dashboard/dnc/_components/dnc-list.tsx
@src/components/client/sidebar-nav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration, preview data layer, and exclude action</name>
  <files>
    supabase/migrations/20260218000001_preview_exclusions.sql
    src/lib/data/preview-data.ts
    src/lib/actions/preview-actions.ts
  </files>
  <action>
1. Create migration `supabase/migrations/20260218000001_preview_exclusions.sql`:
   - ALTER TABLE public.synced_leads ADD COLUMN IF NOT EXISTS is_excluded BOOLEAN DEFAULT FALSE
   - Create partial index: CREATE INDEX idx_synced_leads_preview ON public.synced_leads(client_id, lead_status, is_excluded) WHERE lead_status = 'not_yet_emailed' AND is_excluded = FALSE
   - Create RLS UPDATE policy: "Clients can exclude own leads" on synced_leads FOR UPDATE TO authenticated USING (client_id::TEXT = (SELECT auth.jwt() ->> 'client_id')) WITH CHECK (client_id::TEXT = (SELECT auth.jwt() ->> 'client_id'))

2. Create `src/lib/data/preview-data.ts`:
   - Export interface PreviewContact { id: string; fullName: string; companyName: string | null; jobTitle: string | null; industry: string | null; email: string; updatedAt: string }
   - Export async function getPreviewContacts(clientId: string): Promise<PreviewContact[]>
   - Query synced_leads with .eq('client_id', clientId).eq('lead_status', 'not_yet_emailed').eq('is_excluded', false).order('updated_at', { ascending: false })
   - Deduplicate by email using Set (same pattern as getContactList in campaign-stats.ts and getPositiveLeadsForInbox in inbox-data.ts)
   - Map rows to PreviewContact: fullName = [first_name, last_name].filter(Boolean).join(' ') || email
   - Use the lead's updated_at as the reference date for the "Contactdatum" column (Instantly has no scheduled_date)

3. Create `src/lib/actions/preview-actions.ts`:
   - 'use server' directive
   - Import createClient from @/lib/supabase/server, revalidatePath from next/cache
   - Export async function excludeContact(leadId: string): Promise<{ success: true } | { error: string }>
   - Validate leadId is non-empty, return { error: 'Ongeldig contact-ID.' } if not
   - Auth check: supabase.auth.getUser(), check user and user.app_metadata?.client_id
   - Update synced_leads: .update({ is_excluded: true }).eq('id', leadId) (RLS ensures client can only update own leads)
   - On error: return { error: 'Fout bij het verwijderen. Probeer het opnieuw.' }
   - On success: revalidatePath('/dashboard/voorvertoning'), return { success: true }
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles. Check migration SQL is syntactically valid.</verify>
  <done>Migration file adds is_excluded column + index + RLS policy. getPreviewContacts returns deduplicated not_yet_emailed contacts. excludeContact soft-deletes a lead with proper auth.</done>
</task>

<task type="auto">
  <name>Task 2: Preview page UI, sidebar nav update, and DNC filter integration</name>
  <files>
    src/app/(client)/dashboard/voorvertoning/page.tsx
    src/app/(client)/dashboard/voorvertoning/_components/preview-table.tsx
    src/components/client/sidebar-nav.tsx
    src/lib/actions/csv-actions.ts
  </files>
  <action>
1. Create `src/app/(client)/dashboard/voorvertoning/page.tsx`:
   - export const dynamic = 'force-dynamic'
   - Server component that calls getClientBranding() for auth (redirect to /login if null)
   - Calls getPreviewContacts(client.id)
   - Renders heading "Contactvoorvertoning" with subtitle "Contacten die binnenkort worden benaderd."
   - If contacts empty: show "Geen contacten gevonden voor de komende periode." message
   - Otherwise render <PreviewTable contacts={contacts} />
   - Follow exact same pattern as inbox/page.tsx for auth + data fetching

2. Create `src/app/(client)/dashboard/voorvertoning/_components/preview-table.tsx`:
   - 'use client' directive
   - Import excludeContact from @/lib/actions/preview-actions
   - Import { format } from 'date-fns' and { nl } from 'date-fns/locale'
   - Props: { contacts: PreviewContact[] }
   - State: removing (string | null for loading state), feedback ({ type: 'success' | 'error', message: string } | null)
   - Table with Dutch column headers: Volledige naam, Bedrijfsnaam, Contactdatum, Sector/Industrie, Functie, Actie
   - Contactdatum column: format(new Date(contact.updatedAt), 'd MMM yyyy', { locale: nl })
   - Each row has a red "Verwijderen" button in the Actie column
   - Button calls handleExclude(contact.id): sets removing state, calls excludeContact, shows feedback, auto-dismiss after 3s
   - Disabled state on button while removing === contact.id (show "Bezig..." text)
   - Use same Tailwind table styling as DNC list (border, rounded, divide-y pattern)
   - State-based feedback div above table (green for success, red for error) matching Phase 5 pattern

3. Update `src/components/client/sidebar-nav.tsx`:
   - Add a new nav item BEFORE "Voorkeuren" (after "Verzonden"):
     - href: '/dashboard/voorvertoning'
     - label: 'Voorvertoning'
     - icon: eye SVG icon (Heroicons outline eye): `<path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />`

4. Modify `src/lib/actions/csv-actions.ts` â€” in the applyDncFilter function:
   - After Step 2 (fetching DNC entries and building dncEmails/dncDomains Sets), add a new step:
   - Fetch excluded emails: query synced_leads with admin client: .select('email').eq('client_id', clientId).eq('is_excluded', true)
   - Add all excluded emails (lowercased) to the dncEmails Set
   - This ensures excluded contacts are filtered during CSV export without needing a separate filter_reason
   - Note: the "If no DNC entries" early return at line ~261 must be updated to also check if excludedEmails exist (i.e., only skip if dncEmails.size === 0 && dncDomains.size === 0 AND no excluded emails were added)
  </action>
  <verify>Run `npx next build` to verify build succeeds. Verify sidebar-nav.tsx has 7 nav items. Verify csv-actions.ts applyDncFilter references is_excluded.</verify>
  <done>Preview page renders at /dashboard/voorvertoning with table and delete buttons. Sidebar has "Voorvertoning" nav item. DNC filter export excludes client-removed contacts.</done>
</task>

</tasks>

<verification>
- `npx next build` passes without errors
- Preview page route exists at /dashboard/voorvertoning
- Sidebar has 7 navigation items (Overzicht, Inbox, Verzonden, Voorvertoning, Voorkeuren, DNC, Afspraken)
- csv-actions.ts applyDncFilter includes is_excluded check
- Migration file has is_excluded column, index, and UPDATE RLS policy
</verification>

<success_criteria>
- PREV-01: Preview table shows not_yet_emailed contacts with all required columns (full name, company, date, sector, job title)
- PREV-02: Delete button on each row calls excludeContact which soft-deletes via is_excluded flag
- PREV-03: applyDncFilter includes excluded contacts in its filtering set
- Navigation: Sidebar includes "Voorvertoning" link
</success_criteria>

<output>
After completion, create `.planning/phases/07-contact-preview-sent-emails/07-01-SUMMARY.md`
</output>
